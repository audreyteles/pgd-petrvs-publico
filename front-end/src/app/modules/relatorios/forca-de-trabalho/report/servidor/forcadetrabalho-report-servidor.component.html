<toolbar [title]="isModal ? '' : title" [buttons]="buttons" [hidden]="true"></toolbar>

<div *ngFor="let x of rows" class="mt-5">
  <!-- Informações sobre cada Plano (como só existe um PlanoRelatório mesmo...) -->
  <div class="mt-5">
    <table class="table table-striped table-bordered table-hover my-4">
      <thead>
        <tr>
          <th colspan="3" class="text-center"><strong>CRITÉRIOS PARA O RELATÓRIO</strong></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Data e hora do Relatório</td>
          <td>{{ this.util.getDateTimeFormatted(horaAtual) }}</td>
          <td>Marco temporal para as informações/estatísticas constantes do presente relatório.</td>
        </tr>
        <tr>
          <td>Servidor</td>
          <td colspan="2">{{ (usuario?.nome || '').toUpperCase() }}</td>
        </tr>
        <tr>
          <td>Plano</td>
          <td colspan="2">{{ x.descricaoPlano }}</td>
        </tr>
        <tr *ngIf="buscaPorPeriodo">
          <td>Período de pesquisa</td>
          <td colspan="2">De {{ this.util.getDateTimeFormatted(parametros.data_inicio) }} a {{
            this.util.getDateTimeFormatted(parametros.data_fim) }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Gráficos do período usando ng2-charts -->
  <div *ngIf="buscaPorPeriodo" class="my-4 text-center">
    <h3 class="border border-primary bg-secondary my-4 ps-4" style="text-align: left;">Análise do Período</h3>
    <div>
      <div class="border border-primary bg-light mx-1 d-inline-block chart-container" style="position: relative">
        <app-bar-chart barChartType="bar" [barChartData]="x.dadosGraficoPeriodoComparativo"
          [barChartOptions]="opcoesGraficoPeriodoComparativo">
        </app-bar-chart>
      </div>
<!--       <div class="border border-primary bg-light mx-1 d-inline-block chart-container" style="position: relative">
        <app-bar-chart barChartType="bar" [barChartData]="x.dadosGraficoPeriodoPizza"
          [barChartOptions]="opcoesGraficoPeriodoPizza">
        </app-bar-chart>
      </div> -->
      <div class="border border-primary bg-light mx-1 d-inline-block chart-container" style="position: relative">
        <app-bar-chart barChartType="horizontalBar" [barChartData]="x.dadosGraficoPeriodoDetalhado"
          [barChartOptions]="opcoesGraficoPeriodoDetalhado">
        </app-bar-chart>
      </div>
    </div>
  </div>

  <!--   <div *ngIf="buscaPorPeriodo" class="m-4 text-center">
    <h3 class="border border-primary bg-secondary my-4 ps-4" style="text-align: left;">Análise do Período</h3>
    <div class="row d-flex justify-content-between">
      <div class="border border-primary bg-light mx-1 chart-container">
        <app-bar-chart barChartType="bar" [barChartData]="x.dadosGraficoPeriodoComparativo"
          [barChartOptions]="opcoesGraficoPeriodoComparativo">
        </app-bar-chart>
      </div>
      <div class="border border-primary bg-light mx-1 chart-container">
        <app-bar-chart barChartType="bar" [barChartData]="x.dadosGraficoPeriodoPizza"
          [barChartOptions]="opcoesGraficoPeriodoPizza">
        </app-bar-chart>
      </div>
      <div class="border border-primary bg-light mx-1 chart-container">
        <app-bar-chart barChartType="bar" [barChartData]="x.dadosGraficoPeriodoDetalhado"
          [barChartOptions]="opcoesGraficoPeriodoDetalhado">
        </app-bar-chart>
      </div>
    </div>
  </div> -->

  <!-- Informações sobre o período -->
  <div *ngIf="buscaPorPeriodo" class="text-center">
    <table class="table table-bordered table-hover align-middle text-center" style="width: 700px; margin:auto">
      <thead class="table-active">
        <tr>
          <th colspan="5"><strong>DEMANDAS</strong></th>
        </tr>
        <tr style="vertical-align: middle;">
          <th><strong>CATEGORIAS</strong></th>
          <th><strong>QDE</strong></th>
          <th><strong>HORAS TOTAIS</strong> <sup>(*1)</sup></th>
          <th><strong>HORAS PREVISTAS<br>NO PERÍODO</strong> <sup>(*2)</sup></th>
          <th><strong>HORAS REGISTRADAS<br>NO PERÍODO</strong> <sup>(*3)</sup></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Não iniciadas</td>
          <td>{{ x.extras.noPeriodo.demandasNaoIniciadas?.length || 0 }}</td>
          <td>{{ x.extras.noPeriodo.tempoTotalNaoIniciadas == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalNaoIniciadas, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoPrevistoNaoIniciadasNoPeriodo == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoPrevistoNaoIniciadasNoPeriodo, true)) }}</td>
          <td>-</td>
        </tr>
        <tr>
          <td>Em andamento</td>
          <td>{{ x.extras.noPeriodo.demandasEmAndamento?.length || 0 }}</td>
          <td>{{ x.extras.noPeriodo.tempoTotalEmAndamento == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalEmAndamento, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoPrevistoEmAndamentoNoPeriodo == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoPrevistoEmAndamentoNoPeriodo, true)) }}</td>
          <td>(não estimado)</td>
        </tr>
        <tr>
          <td>Concluídas e não avaliadas</td>
          <td>{{ x.extras.noPeriodo.demandasSoConcluidas?.length || 0 }}</td>
          <td>{{ x.extras.noPeriodo.tempoTotalSoConcluidas == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalSoConcluidas, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoPrevistoSoConcluidasNoPeriodo == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoPrevistoSoConcluidasNoPeriodo, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoDespendidoSoConcluidas == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoDespendidoSoConcluidas, true)) }}</td>
        </tr>
        <tr>
          <td>Avaliadas, mas reprovadas</td>
          <td>{{ x.extras.noPeriodo.demandasReprovadas?.length || 0 }}</td>
          <td>{{ x.extras.noPeriodo.tempoTotalReprovadas == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalReprovadas, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoPrevistoReprovadasNoPeriodo == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoPrevistoReprovadasNoPeriodo, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoTrabalhadoNaoHomologado == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTrabalhadoNaoHomologado, true)) }}</td>
        </tr>
        <tr>
          <td>Avaliadas, e aprovadas</td>
          <td>{{ x.extras.noPeriodo.demandasAprovadas?.length || 0 }}</td>
          <td>{{ x.extras.noPeriodo.tempoTotalAprovadas == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalAprovadas, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoPrevistoAprovadasNoPeriodo == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoPrevistoAprovadasNoPeriodo, true)) }}</td>
          <td>{{ x.extras.noPeriodo.tempoTrabalhadoHomologado == 0 ? 0 :
            (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTrabalhadoHomologado, true)) }}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr class="table-active" style="font-weight: bold;">
          <td><strong>Distribuídas</strong></td>
          <td><strong>{{ x.extras.noPeriodo.demandasDistribuidas?.length || 0 }}</strong></td>
          <td><strong>{{ x.extras.noPeriodo.tempoTotalAlocado == 0 ? 0 :
              (this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalAlocado, true)) }}</strong></td>
          <td><strong>{{ this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalPrevistoNoPeriodo, true)
              }}</strong></td>
          <td><strong>{{ this.util.decimalToTimerFormated(x.extras.noPeriodo.tempoTotalRealizadoNoPeriodo, true)
              }}</strong></td>
        </tr>
        <tr>
          <td colspan="5" style="text-align: left; font-size: small;">
            <strong>(*1)</strong> Soma dos tempos pactuados.<br>
            <strong>(*2)</strong> Soma dos tempos pactuados previstos para o período da pesquisa.<br>
            <strong>(*3)</strong> Soma dos tempos efetivamente trabalhados pelo servidor; as horas trabalhadas nas
            demandas em andamento não são computadas por não haver registros suficientes no sistema.<br>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Gráficos do Plano usando ng2-charts -->
  <div class="m-4 text-center">
    <h3 class="border border-primary bg-secondary my-4 ps-4" style="text-align: left;">Análise do Plano</h3>
    <div class="border border-primary bg-light mx-4 d-inline-block container" style="position: relative; width:400px">
      <h5>Horas do Plano</h5>
      <app-bar-chart barChartType="bar" [barChartData]="x.dadosGraficoPlano" [barChartOptions]="opcoesGraficoPlano">
      </app-bar-chart>
    </div>
    <div class="border border-primary bg-light mx-4 d-inline-block container" style="position: relative; width:400px">
      <h5>Horas das Demandas</h5>
      <app-bar-chart barChartType="horizontalBar" [barChartData]="x.dadosGraficoDemandas"
        [barChartOptions]="opcoesGraficoDemandas">
      </app-bar-chart>
    </div>
  </div>

  <!-- Informações sobre o Plano -->
  <table class="table table-bordered table-hover align-middle text-center">
    <thead>
      <tr class="table-active">
        <th colspan="6"><strong>INFORMAÇÕES SOBRE O PLANO</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="3" style="text-align: right;">Nome do Plano</td>
        <td colspan="3">{{ x.descricaoPlano }}</td>
      </tr>
      <tr>
        <td colspan="3" style="text-align: right;">Unidade</td>
        <td colspan="3">{{ x.plano.unidade?.sigla }}</td>
      </tr>
      <tr>
        <td colspan="3" style="text-align: right;">Status do Plano</td>
        <td colspan="3">{{ x.statusPlano }}</td>
      </tr>
      <tr>
        <td rowspan="4" class="vertical">
          <div>Horas Totais</div>
        </td>
      </tr>
      <tr>
        <td>HUTP</td>
        <td>Horas úteis totais do Plano</td>
        <td>{{ x.extras.horasUteisTotais == 0 ? 0 : (this.util.decimalToTimerFormated(x.extras.horasUteisTotais, true))
          }}</td>
        <td>100.00 %</td>
        <td>
          <span>
            <small class="micro-text fw-ligh">Horas úteis do Plano de Trabalho, ao longo de toda sua vigência,
              considerando-se a carga horária, os feriados e finais de semana. É a base de cálculo para a maioria dos
              percentuais.</small>
          </span>
        </td>
      </tr>
      <tr>
        <td>HUAS</td>
        <td>Horas úteis de afastamento do Servidor</td>
        <td>{{ this.util.decimalToTimerFormated(x.extras.horasUteisAfastamento, true) }}</td>
        <td>{{ x.percentualAfastamento }} %</td>
        <td><span><small class="micro-text fw-ligh">Total das horas úteis dos afastamentos do servidor compreendidos no
              período do Plano. O percentual indica a relação entre esse total e as horas úteis totais do
              Plano.</small></span></td>
      </tr>
      <tr>
        <td>HULP</td>
        <td>Horas úteis líquidas do Plano</td>
        <td>{{ this.util.decimalToTimerFormated(x.horasUteisLiquidasPlano, true) }}</td>
        <td>{{ x.percentualHorasUteisLiquidasPlano }} %</td>
        <td><span><small class="micro-text fw-ligh">Total das horas úteis do Plano para alocação de demandas: HULP =
              HUTP - HUAS.<br>O percentual indica a relação entre esse total e as horas úteis totais do Plano: HULP(%) =
              HULP / HUTP.</small></span></td>
      </tr>
      <tr>
        <td rowspan="3" class="vertical">
          <div>Horas Decorridas</div>
        </td>
      </tr>
      <tr>
        <td>HUDP</td>
        <td>Horas úteis decorridas do Plano</td>
        <td>{{ x.extras.horasUteisDecorridas == 0 ? 0 : this.util.decimalToTimerFormated(x.extras.horasUteisDecorridas,
          true) }}</td>
        <td>{{ x.percentualDecorridoPlano }} %</td>
        <td><span><small class="micro-text fw-ligh">{{ x.extras.horasUteisDecorridas == 0 ? 'A vigência do Plano ainda
              não iniciou.' : (x.extras.horasUteisDecorridas == x.extras.horasUteisTotais ? 'A vigência do Plano já
              encerrou.' : 'Horas úteis do Plano de Trabalho, do início de sua vigência até o instante atual,
              considerando-se a carga horária, os feriados e finais de semana.') }}</small></span></td>
      </tr>
      <tr>
        <td>HUDA</td>
        <td>Horas úteis decorridas de afastamento</td>
        <td>{{ this.util.decimalToTimerFormated(x.extras.horasAfastamentoDecorridas, true) }}</td>
        <td>{{ x.percentualDecorridoAfastamentos }} %</td>
        <td><span><small class="micro-text fw-ligh">{{ x.extras.horasUteisDecorridas == 0 ? 'A vigência do Plano ainda
              não iniciou.' : (x.extras.horasUteisDecorridas == x.extras.horasUteisTotais ? 'Total das horas úteis dos
              afastamentos do Servidor ocorridos entre o início e o fim da vigência do Plano. O percentual indica a
              fração já decorrida em relação ao total previsto.' : 'Total das horas úteis dos afastamentos do Servidor
              ocorridos entre o início da vigência do Plano e o instante atual.') }}</small></span></td>
      </tr>
      <tr>
        <td rowspan="3" class="vertical">
          <div>Horas a Decorrer</div>
        </td>
      </tr>
      <tr>
        <td>HLPT</td>
        <td>Horas líquidas do Plano a transcorrer</td>
        <td>{{ this.util.decimalToTimerFormated(x.horasDisponiveisPlano, true) }}</td>
        <td>{{ x.percentualHorasDisponiveis }} %</td>
        <td><span><small class="micro-text fw-ligh">Total das horas úteis líquidas do Plano ainda a
              transcorrer.</small></span></td>
      </tr>
      <tr>
        <td>HAT</td>
        <td>Horas de Afastamento a transcorrer</td>
        <td>{{ this.util.decimalToTimerFormated(x.horasAfastamentoTranscorrer, true) }}</td>
        <td>{{ x.percentualHorasAfastamentoTranscorrer }} %</td>
        <td><span><small class="micro-text fw-ligh">Total das horas úteis de afastamento do servidor ainda a
              transcorrer.</small></span></td>
      </tr>
      <tr>
        <td rowspan="6" class="vertical">
          <div>Horas das Demandas</div>
        </td>
      </tr>
      <tr>
        <td>THNI</td>
        <td>Total de horas não-iniciadas</td>
        <td>{{ x.extras.horasDemandasNaoIniciadas == 0 ? 0 :
          this.util.decimalToTimerFormated(x.extras.horasDemandasNaoIniciadas, true) }}</td>
        <td>{{ x.percentualHorasNaoIniciadas }} %</td>
        <td>
          <span>
            <small class="micro-text fw-ligh">Total dos tempos pactuados de todas as demandas ainda não
              iniciadas.</small>
            <br><small class="micro-text fw-ligh">O percentual representa a relação entre este total e as horas úteis
              totais do Plano:<br>THNI(%) = THNI / HUTP.</small>
          </span>
        </td>
      </tr>
      <tr>
        <td>THAn</td>
        <td>Total de horas em andamento</td>
        <td>{{ x.extras.horasDemandasEmAndamento == 0 ? 0 :
          this.util.decimalToTimerFormated(x.extras.horasDemandasEmAndamento, true) }}</td>
        <td>{{ x.percentualHorasEmAndamento }} %</td>
        <td>
          <span>
            <small class="micro-text fw-ligh">Total dos tempos pactuados de todas as demandas já iniciadas, mas ainda
              não concluídas.</small>
            <br><small class="micro-text fw-ligh">O percentual representa a relação entre este total e as horas úteis
              totais do Plano:<br>THAn(%) = THAn / HUTP.</small>
          </span>
        </td>
      </tr>
      <tr>
        <td>THC</td>
        <td>Total de horas concluídas</td>
        <td>{{ x.extras.horasDemandasConcluidas == 0 ? 0 :
          this.util.decimalToTimerFormated(x.extras.horasDemandasConcluidas, true) }}</td>
        <td>{{ x.percentualHorasConcluidas }} %</td>
        <td>
          <span>
            <small class="micro-text fw-ligh">Total dos tempos pactuados de todas as demandas já concluídas, mas ainda
              não avaliadas.</small>
            <br><small class="micro-text fw-ligh">O percentual representa a relação entre este total e as horas úteis
              totais do Plano:<br>THC(%) = THC / HUTP.</small>
          </span>
        </td>
      </tr>
      <tr>
        <td>THAv</td>
        <td>Total de horas avaliadas</td>
        <td>{{ x.extras.horasDemandasAvaliadas == 0 ? 0 :
          this.util.decimalToTimerFormated(x.extras.horasDemandasAvaliadas, true) }}</td>
        <td>{{ x.percentualHorasAvaliadas }} %</td>
        <td>
          <span>
            <small class="micro-text fw-ligh">Total dos tempos pactuados de todas as demandas avaliadas.</small>
            <br><small class="micro-text fw-ligh">O percentual representa a relação entre este total e as horas úteis
              totais do Plano:<br>THAv(%) = THAv / HUTP.</small>
          </span>
        </td>
      </tr>
      <tr>
        <td>HTA</td>
        <td>Horas totais alocadas do Plano</td>
        <td>{{ x.extras.horasTotaisAlocadas == 0 ? 0 : (this.util.decimalToTimerFormated(x.extras.horasTotaisAlocadas,
          true)) }}</td>
        <td>{{ x.percentualHorasTotaisAlocadas }} %</td>
        <td>
          <span>
            <small class="micro-text fw-ligh">Total dos tempos pactuados de todas as demandas, independente de seus
              status:<br>HTA = THNI + THAn + THC + THAv.</small>
            <br><small class="micro-text fw-ligh">O percentual representa a relação entre este total e as horas úteis
              totais do Plano:<br>HTA(%) = HTA / HUTP.</small>
          </span>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="text-center">NMA</td>
        <td>Nota média das avaliações</td>
        <td>{{ x.extras.demandasAvaliadas?.length > 0 ? x.extras.mediaAvaliacoes.toFixed(2) : '' }}</td>
        <td></td>
        <td>
          <span *ngIf="x.extras.demandasAvaliadas?.length > 0"><small class="micro-text fw-ligh">Média das notas de
              todas as demandas avaliadas.</small></span>
          <span *ngIf="x.extras.demandasAvaliadas?.length == 0"><small class="micro-text fw-ligh">Este Plano não possui
              demandas avaliadas.</small></span>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Informações sobre as demandas avaliadas do plano -->
  <div class="text-center my-4">
    <span><strong>Análise individual das demandas avaliadas</strong></span>
  </div>
  <table class="table table-hover text-center">
    <thead>
      <tr class="table-active">
        <th scope="col">#ID/nº Processo</th>
        <th scope="col">Assunto</th>
        <th scope="col">Nota da Avaliação</th>
        <!-- <th scope="col">Gráfico</th> -->
      </tr>
    </thead>
    <tbody>
      <tr *ngIf="!x.extras.demandasAvaliadas?.length">
        <td style="padding:8px;" colspan="3">
          <h5 style="text-align:center;">O servidor não possui demandas avaliadas, associadas a este Plano de Trabalho!
          </h5>
        </td>
      </tr>
      <tr *ngFor="let da of x.extras.demandasAvaliadas">
        <td>
          <span class="text-wrap">
            <small class="micro-text fw-ligh">#{{ da.numero }}</small>
            <span class="badge bg-light text-dark">
              <i [class]="'bi bi bi-x-lg'"></i>
              {{ da.numero_processo?.length ? da.numero_processo : "Não processual" }}
            </span>
          </span>
        </td>
        <td>
          <div>
            <span class="badge bg-light text-dark text-wrap">{{ da.assunto }}</span>
          </div>
        </td>
        <td>
          <div>
            <span>{{ da.avaliacao.nota_atribuida.toFixed(2) }}</span>
          </div>
        </td>
        <!--         <td>
          <app-bar-chart
            barChartType="horizontalBar"
            [barChartData]="x.dadosGraficoHoras"
            [barChartOptions]="opcoesGraficoHoras">
          </app-bar-chart>
        </td> -->
      </tr>
    </tbody>
  </table>
</div>

<toolbar [buttons]="buttons" [hidden]="true"></toolbar>