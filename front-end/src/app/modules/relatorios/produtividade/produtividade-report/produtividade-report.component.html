<toolbar [title]="isModal ? '' : title" [buttons]="buttons"></toolbar>

<div class="mt-5">
  <table class="table table-striped table-bordered table-hover my-4">
    <thead>
      <tr>
        <th colspan="3" class="text-center"><strong>CRITÉRIOS PARA O RELATÓRIO</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Data e hora do Relatório</td>
        <td>{{ this.util.getDateTimeFormatted(horaAtual) }}</td>
        <td>Marco temporal para as informações/estatísticas constantes do presente relatório.</td>
      </tr>
      <tr>
        <td>Servidor</td><td colspan="2">{{ (usuario?.nome || '').toUpperCase() }}</td>
      </tr>
      <tr>
        <td>Unidade</td><td colspan="2">{{ unidade?.sigla }}</td>
      </tr>
      <tr>
        <td>Tipo de Relatório</td><td colspan="2">{{ parametros?.tipo_relatorio == 'POR_PLANO' ? "POR PLANO DE TRABALHO" : "POR PERÍODO" }}</td>
      </tr>
      <tr *ngIf="parametros?.tipo_relatorio == 'POR_PLANO'">
        <td>Plano</td><td colspan="2">{{ descricaoPlano }}</td>
      </tr>
      <tr *ngIf="parametros?.tipo_relatorio == 'POR_PERIODO'">
        <td>Período do Relatório</td><td colspan="2">{{ descricaoPeriodo }}</td>
      </tr>
      <tr *ngIf="parametros?.tipo_relatorio == 'POR_PERIODO'">
        <td>Qde de Planos no período</td>
        <td>{{ rows?.length }}</td>
        <td>Planos de Trabalho cuja vigência tem alguma interseção com o período do relatório.</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- RESOLVER O ERRO ExpressionChangedAfterItHasBeenCheckedError -->

<div class="mt-5">
  <h5 *ngIf="!rows?.length" style="text-align:center;">O servidor não possui nenhum Plano de Trabalho que atenda aos critérios selecionados (Unidade/Período)!</h5>
  <div *ngIf="rows?.length">
    <div *ngFor="let x of rows; let i=index"> <!-- Informações sobre cada Plano -->

      <!-- Gráficos do Plano usando ng2-charts -->
      <div class="my-4 text-center">
        <div class="container border border-primary bg-light d-inline-block mx-4" style="position: relative; width:400px">
          <h5>Composição do Plano por Demandas</h5>
            <bar-chart
              [dadosGrafico]="x.dadosGraficoPlano"
              [opcoesGrafico]="opcoesGraficoPlano">
            </bar-chart>
        </div>
        <div class="container border border-primary bg-light d-inline-block mx-4" style="position: relative; width:400px">
          <h5>Distribuição dos Tempos no Plano</h5>
            <bar-chart
              [tipoGrafico]="tipoGrafico"
              [dadosGrafico]="x.dadosGraficoHoras"
              [opcoesGrafico]="opcoesGraficoHoras">
            </bar-chart>
        </div>
      </div>

      <table class="table table-striped table-bordered table-hover my-4">
        <thead>
          <tr>
            <th colspan="3" class="text-center"><strong>INFORMAÇÕES SOBRE O PLANO{{ rows!.length > 1 ? ' NR. ' + (i + 1) : '' }}</strong></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Nome do Plano</td><td colspan="2">{{ x.extras.descricaoPlano }}</td>
          </tr>
          <tr>
            <td>Unidade</td><td colspan="2">{{ x.plano.unidade?.sigla }}</td>
          </tr>
          <tr>
            <td>Status do Plano</td><td colspan="2">{{ x.extras.concluido ? 'CONCLUÍDO - estatísticas CONCLUSIVAS' : 'EM ANDAMENTO - estatísticas sujeitas a alterações' }}</td>
          </tr>
          <tr>
            <td>Horas totais do Plano</td>
            <td class="text-center ">{{ x.extras.horasTotais == 0 ? 0 : (this.util.decimalToTimerFormated(x.extras.horasTotais, true)) }}</td>
            <td><span><small class="micro-text fw-ligh">Cálculo simples: intervalo de vigência do Plano, em horas.</small></span></td>
          </tr>
          <tr>
            <td>Horas decorridas do Plano</td>
            <td class="text-center ">{{ x.extras.horasDecorridas == 0 ? 0 : (this.util.decimalToTimerFormated(x.extras.horasDecorridas, true)) }}</td>
            <td><span><small class="micro-text fw-ligh">Cálculo simples: intervalo entre o início da vigência do Plano e o instante atual, em horas.</small></span></td>
          </tr>
          <tr>
            <td>Demandas concluídas</td>
            <td class="text-center ">{{ x.extras.demandasConcluidas?.length ? x.extras.demandasConcluidas?.length : 0 }}</td>
            <td><span><small class="micro-text fw-ligh">Todas as demandas assim definidas pelo servidor.</small></span></td>
          </tr>
          <tr>
            <td>Total de horas concluídas</td>
            <td class="text-center ">{{ x.extras.horasDemandasConcluidas == 0 ? 0 : this.util.decimalToTimerFormated(x.extras.horasDemandasConcluidas, true) }}</td>
            <td><span><small class="micro-text fw-ligh">Soma do tempo despendido em todas as demandas concluídas.</small></span></td>
          </tr>
          <tr>
            <td>Demandas avaliadas</td>
            <td class="text-center ">{{ x.extras.demandasAvaliadas?.length ? x.extras.demandasAvaliadas?.length : 0 }}</td>
            <td><span><small class="micro-text fw-ligh">Todas aquelas para as quais foi realizada uma avaliação.</small></span></td>
          </tr>
          <tr>
            <td>Total de horas avaliadas</td>
            <td class="text-center ">{{ x.extras.horasDemandasAvaliadas == 0 ? 0 : this.util.decimalToTimerFormated(x.extras.horasDemandasAvaliadas, true) }}</td>
            <td><span><small class="micro-text fw-ligh">Soma do tempo homologado de todas as demandas avaliadas.</small><br><small class="micro-text fw-ligh">Tempo efetivamente contabilizado para fins de produtividade.</small></span></td>
          </tr>
          <tr>
            <td>Demandas cumpridas</td>
            <td class="text-center ">{{ x.extras.demandasCumpridas?.length ? x.extras.demandasCumpridas?.length : 0 }}</td>
            <td><span><small class="micro-text fw-ligh">Todas as demandas concluídas que dispensam avaliação ou com avaliação já realizada.</small></span></td>
          </tr>
          <tr>
            <td>Total de horas cumpridas</td>
            <td class="text-center ">{{ x.extras.horasDemandasCumpridas == 0 ? 0 : this.util.decimalToTimerFormated(x.extras.horasDemandasCumpridas, true) }}</td>
            <td><span><small class="micro-text fw-ligh">Soma do tempo homologado de todas as demandas cumpridas.</small><br><small class="micro-text fw-ligh">Tempo contabilizado para o cálculo do % cumprido do Plano.</small></span></td>
          </tr>
          <tr>
            <td>Tempo total do Plano</td>
            <td class="text-center ">{{ x.extras.tempoTotal == 0 ? 0 : this.util.decimalToTimerFormated(x.extras.tempoTotal, true) }}</td>
            <td><span><small class="micro-text fw-ligh">Horas úteis do Plano de Trabalho, considerando-se a carga_horaria, os feriados e finais de semana. Tempo contabilizado para o cálculo do % cumprido do Plano.</small></span></td>
          </tr>
          <tr>
            <td>Percentual do Plano efetivamente cumprido</td>
            <td class="text-center ">{{ x.extras.percentualCumprido }} %</td>
            <td><span><small class="micro-text fw-ligh">Relação entre o total de horas cumpridas e o tempo total do plano.</small></span></td>
          </tr>
          <tr>
            <td>Percentual de cumprimento do Plano esperado</td>
            <td class="text-center ">{{ x.extras.percentualEsperado }} %</td>
            <td><span><small class="micro-text fw-ligh">Relação entre as horas já decorridas e as horas totais do plano.</small></span></td>
          </tr>
          <tr>
            <td>{{ x.extras.concluido ? 'Eficiência' : 'Eficiência estimada' }}</td>
            <td class="text-center ">{{ x.extras.eficiencia }} %</td>
            <td><span><small class="micro-text fw-ligh">Relação entre o % Cumprido do plano e % Esperado do seu cumprimento.</small></span></td>
          </tr>
          <tr *ngIf="x.extras.concluido">
            <td>Produtividade Média</td>
            <td class="text-center ">{{ x.extras.produtividadeMedia }} %</td>
            <td><span><small class="micro-text fw-ligh">Média da produtividade de todas as demandas concluídas.</small></span></td>
          </tr>
        </tbody>
      </table>

      <!-- Informações sobre as demandas avaliadas do plano -->
      <div>
        <span><strong>Análise individual das demandas</strong></span>
      </div>
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">#ID/nº Processo</th>
            <th scope="col">Assunto</th>
            <th scope="col">Produtividade</th>
      <!--         <th scope="col">Gráfico</th> -->
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="!x.extras.demandasAvaliadas?.length">
            <td style="padding:8px;" colspan="3">
              <h5 style="text-align:center;">O servidor não possui demandas avaliadas, associadas a este Plano de Trabalho!</h5>
            </td>
          </tr>
          <tr *ngFor="let row of x.extras.demandasAvaliadas">
            <td>
              <span class="text-wrap">
                <small class="micro-text fw-ligh">#{{ row.numero }}</small>
                <span class="badge bg-light text-dark">
                    <i [class]="'bi bi bi-x-lg'"></i>
                    {{ row.numero_processo?.length ? row.numero_processo : "Não processual" }}
                </span>
              </span>
            </td>
            <td>
              <div>
                <span class="badge bg-light text-dark text-wrap">{{ row.assunto }}</span>
              </div>
            </td>
            <td>
              <div class="one-per-line">
                <span [class]="'tempo.class'"><i [class]="'tempo.icon'"></i> {{ row.produtividade }}%</span>
              </div>
            </td>
          <!--             <td>
              <bar-chart
                [barChartType]="tipoGrafico"
                [barChartLabels]="labelsX"
                [dadosGrafico]="row.produtividade"
                [opcoesGrafico]="opcoesGraficoRow">
            </bar-chart>
            </td> -->
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<toolbar [buttons]="buttons"></toolbar>
