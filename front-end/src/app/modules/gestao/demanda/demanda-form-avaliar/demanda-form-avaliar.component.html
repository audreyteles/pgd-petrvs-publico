<top-alert *ngIf="entity?.plano?.tipo_modalidade?.calcula_tempo_despendido && form!.controls.tempo_despendido.value < despendidoMinimo" type="warning" [message]="'Tempo despendido abaixo do mínimo esperado (' + util.decimalToTimerFormated(despendidoMinimo, true) + ')'"></top-alert>
<editable-form [form]="form!" [disabled]="formDisabled" (submit)="onSaveData()" (cancel)="onCancel()">
    <separator *ngIf="gb.isEmbedded" transparent bottom [collapsed]="false">
        <input-button label="Nº doc. entregue" #docEntregue [size]="4" controlName="numero_documento_entrega" [control]="form!.controls.numero_documento_entrega" disabled labelInfo="Numero do documento entregue, caso seja o Sei é o numero Sei"></input-button>
        <input-text label="Título do documento" [size]="8" controlName="titulo_documento_entrega" [control]="form!.controls.titulo_documento_entrega" disabled labelInfo="Título do documento entregue"></input-text>
    </separator>
    <div class="row">
        <input-search label="Atividade" #atividade [size]="6" controlName="atividade_id" [dao]="atividadeDao" [groupBy]="[{field: 'unidade.sigla', label: 'Unidade'}]" [where]="[['unidade_id', '=', entity?.unidade_id], ['vinculadas', '=', true]]" (select)="onAtividadeSelect($event)" ></input-search>
        <input-select label="Complexidade" [size]="4" controlName="fator_complexidade" [control]="form!.controls.fator_complexidade" [items]="complexidades" (change)="onComplexidadeChange($event)" labelInfo="Multiplicador do tempo da atividade"></input-select>
        <input-switch label="Arquivar" [size]="2" controlName="arquivar" [control]="form!.controls.arquivar" labelInfo="Arquivar automaticamente após a avaliação"></input-switch>      
    </div>
    <div *ngIf="!entity?.plano?.tipo_modalidade?.calcula_tempo_despendido; else comTempoDespendido" class="row">
        <input-timer onlyHours [size]="3" [label]="lex.noun('Tempo pactuado')" disabled controlName="tempo_pactuado" [control]="form!.controls.tempo_pactuado" labelInfo="Tempo calculado a partir da atividade e utilizando o fator_complexidade"></input-timer>
        <input-datetime noIcon [size]="3" [label]="lex.noun('Prazo de entrega')" disabled controlName="prazo_entrega" [control]="form!.controls.prazo_entrega" labelInfo="Data estipulada para entrega da demanda"></input-datetime>
        <input-datetime noIcon [size]="3" label="Data de inicio" disabled controlName="data_inicio" [control]="form!.controls.data_inicio" labelInfo="Data de inicio"></input-datetime>
        <input-datetime noIcon [size]="3" label="Data de entrega" disabled #entrega controlName="data_entrega" [control]="form!.controls.data_entrega" labelInfo="Data e hora da entrega"></input-datetime>
    </div>
    <ng-template #comTempoDespendido>
        <div class="row">
            <input-datetime noIcon [size]="3" [label]="lex.noun('Data de distribuição')" disabled controlName="data_distribuicao" [control]="form!.controls.data_distribuicao" labelInfo="Data de cadastro da demanda"></input-datetime>
            <input-timer [label]="lex.noun('Tempo pactuado')" onlyHours [size]="3" disabled controlName="tempo_pactuado" [control]="form!.controls.tempo_pactuado" labelInfo="Tempo calculado a partir da atividade e utilizando o fator_complexidade"></input-timer>
            <input-datetime noIcon [size]="3" [label]="lex.noun('Prazo de entrega')" disabled controlName="prazo_entrega" [control]="form!.controls.prazo_entrega" labelInfo="Data estipulada para entrega da demanda"></input-datetime>
            <input-timer [label]="atrasado ? 'Atraso' : 'Adiantado'" [size]="3" disabled controlName="diferenca_prazo_entrega" [control]="form!.controls.diferenca_prazo_entrega" [labelInfo]="(atrasado ? 'Tempo de atraso' : 'Tempo adiantado') + ' na realização da demanda'"></input-timer>
        </div>
        <div class="row">
            <input-datetime noIcon [size]="3" label="Data de inicio" disabled controlName="data_inicio" [control]="form!.controls.data_inicio" labelInfo="Data de inicio"></input-datetime>
            <input-timer label="Tempo despendido" [size]="3" disabled controlName="tempo_despendido" [control]="form!.controls.tempo_despendido" labelInfo="Tempo despendido na atividade (considerando fins de semana, feriados e afastamentos)"></input-timer>
            <input-datetime noIcon [size]="3" label="Data de entrega" disabled #entrega controlName="data_entrega" [control]="form!.controls.data_entrega" labelInfo="Data e hora da entrega"></input-datetime>
            <input-text numbers label="Produtividade" sufix="%" [stepValue]="0.01" [size]="3" disabled controlName="produtividade" [control]="form!.controls.produtividade" labelInfo="Diferença entre o tempo pactuado e o despendido (proporcional, em porcentagem)"></input-text>
        </div>
    </ng-template>
    <separator [title]="lex.noun('Entrega', true)" collapse [collapsed]="!entity?.entregas?.length">
        <demanda-list-entrega persist [demanda]="entity"></demanda-list-entrega>
    </separator>    
    <div class="row">
        <input-rate [size]="12" [label]="'Como foi a entrega de ' + util.apelidoOuNome(entity?.usuario) + '?'" (change)="onNotaChange($event)" controlName="nota_atribuida" [control]="form!.controls.nota_atribuida" controlName="rate"></input-rate>
    </div>
    <div *ngIf="tipoAvaliacao" class="d-flex justify-content-center">
        <button type="button" class="pe-none btn" [style]="styleButtonTipoAvaliacao">
            <i [class]="tipoAvaliacao.icon" [style.color]="tipoAvaliacao.color || 'black'"></i>
            <strong class="ms-1">{{tipoAvaliacao.value}}</strong> (Nota: {{tipoAvaliacao.data.nota}})
        </button>
    </div>
    <div *ngIf="tipoAvaliacao">
        <input-multitoggle #justificativas [control]="form!.controls.justificativas" [label]="tipoAvaliacao.data.pergunta" [items]="tiposJustificativas"></input-multitoggle>
    </div>
    <separator *ngIf="tipoAvaliacao" title="Comentários adicionais?" icon="bi bi-chat-left-quote" [collapse]="!form!.controls.comentario_avaliacao.value?.length ? 'true' : undefined">
        <input-textarea label="Comentário" [size]="12" [rows]="2" controlName="comentario_avaliacao" [control]="form!.controls.comentario_avaliacao"></input-textarea>
    </separator>
    <separator *ngIf="false" title="Avaliar outras demandas vinculadas" collapse [collapsed]="false">
        Lista de atividades
    </separator>
</editable-form>
