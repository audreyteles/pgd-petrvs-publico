import{c as v,d as O}from"./chunk-3L5EFWZ5.js";import{o as A}from"./chunk-OWVQDN4P.js";import{Dc as h,Ic as f,O as g,R as d,Wc as D,fd as _,h as m,xc as p}from"./chunk-SDCVQHKS.js";var L=(()=>{let u=class u{constructor(t,e,a,i,s,o,n,r){this.auth=t,this.util=e,this.go=a,this.lookup=i,this.dao=s,this.avaliacaoDao=o,this.templateService=n,this.planoTrabalhoDao=r}template(t){return t.programa?.template_tcr}metadados(t){return{needSign:this.needSign.bind(this),extraTags:this.extraTags.bind(this),especie:"TCR",titulo:"Termo de Ci\xEAncia e Responsabilidade",dataset:this.planoTrabalhoDao.dataset(),datasource:this.planoTrabalhoDao.datasource(t),template:t.programa?.template_tcr,template_id:t.programa?.template_tcr_id}}needSign(t,e){let a=t,i=e||(a?.documentos||[]).find(s=>a?.documento_id?.length&&s.id==a?.documento_id)||a?.documento;if(t&&i&&!i.assinaturas?.find(s=>s.usuario_id==this.auth.usuario.id)){let s=a.tipo_modalidade,o=a.programa,n=this.auth.entidade,r=[];return o?.plano_trabalho_assinatura_participante&&r.push(a.usuario_id),o?.plano_trabalho_assinatura_gestor_lotacao&&r.push(...this.auth.gestoresLotacao.map(c=>c.id)),o?.plano_trabalho_assinatura_gestor_unidade&&r.push(a.unidade?.gestor?.id||"",...a.unidade?.gestores_substitutos?.map(c=>c.id)||""),o?.plano_trabalho_assinatura_gestor_entidade&&r.push(n.gestor_id||"",n.gestor_substituto_id||""),!!s&&r.includes(this.auth.usuario.id)}return!1}extraTags(t,e,a){let i=t,s=[];return i?.documento_id==e.id&&s.push({key:e.id,value:"Vigente",icon:"bi bi-check-all",color:"primary"}),JSON.stringify(a.tags)!=JSON.stringify(s)&&(a.tags=s),a.tags}tipoEntrega(t,e){let a=e||t.plano_trabalho,i=t.plano_entrega_entrega?.plano_entrega?.unidade_id==a.unidade_id?"PROPRIA_UNIDADE":t.plano_entrega_entrega?"OUTRA_UNIDADE":t.orgao?.length?"OUTRO_ORGAO":"SEM_ENTREGA",s=this.lookup.ORIGENS_ENTREGAS_PLANO_TRABALHO.find(r=>r.key==i)||{key:"",value:"Desconhecido1"},o=a?._metadata?.novaEntrega?.plano_entrega_entrega?.entrega?.nome||t.plano_entrega_entrega?.entrega?.nome||"Desconhecido2",n=a?._metadata?.novaEntrega?.plano_entrega_entrega?.descricao||t.plano_entrega_entrega?.descricao||"";return{titulo:s.value,cor:s.color||"danger",nome:o,tipo:i,descricao:n}}atualizarTcr(t,e,a,i){if(e.usuario&&e.unidade){let s=this.dao.datasource(t),o=this.dao.datasource(e),n=e.programa;if(o.usuario.texto_complementar_plano=a||e.usuario?.texto_complementar_plano||"",o.unidade.texto_complementar_plano=i||e.unidade?.texto_complementar_plano||"",(n?.termo_obrigatorio||e.documento_id?.length)&&JSON.stringify(o)!=JSON.stringify(s)&&n?.template_tcr){let r=e.documentos?.find(c=>c.id==e.documento_id);!e.documento_id?.length||!r||r.assinaturas?.length||r.tipo=="LINK"?(r=new v({id:this.dao?.generateUuid(),tipo:"HTML",especie:"TCR",titulo:"Termo de Ci\xEAncia e Responsabilidade",conteudo:this.templateService.renderTemplate(n?.template_tcr?.conteudo||"",o),status:"GERADO",_status:"ADD",template:n?.template_tcr?.conteudo,dataset:this.dao.dataset(),datasource:o,entidade_id:this.auth.entidade?.id,plano_trabalho_id:e.id,template_id:n?.template_tcr_id}),e.documentos.push(r)):(r.conteudo=this.templateService.renderTemplate(n?.template_tcr?.conteudo||"",o),r.dataset=this.dao.dataset(),r.datasource=o,r._status=r._status=="ADD"?"ADD":"EDIT"),e.documento=r,e.documento_id=r?.id||null}}return e.documento}situacaoPlano(t){return t.deleted_at?"EXCLUIDO":t.data_arquivamento?"ARQUIVADO":t.status}isValido(t){return!t.deleted_at&&t.status!="CANCELADO"&&!t.data_arquivamento}estaVigente(t){let e=new Date;return t.status=="ATIVO"&&t.data_inicio<=e&&t.data_fim>=e}diasParaConcluirConsolidacao(t,e){return!t||!e?-1:this.util.daystamp(t.data_fim)+e.dias_tolerancia_avaliacao-this.util.daystamp(this.auth.hora)}avaliar(t,e,a){this.go.navigate({route:["gestao","plano-trabalho","consolidacao",t.id,"avaliar"]},{modal:!0,metadata:{consolidacao:t,programa:e},modalClose:i=>{i&&(t.status="AVALIADO",t.avaliacao_id=i.id,t.avaliacao=i,a(t))}})}fazerRecurso(t,e,a){this.go.navigate({route:["gestao","plano-trabalho","consolidacao",t.id,"recurso"]},{modal:!0,metadata:{recurso:!0,consolidacao:t,programa:e},modalClose:i=>{i&&(t.avaliacao=i,a(t))}})}cancelarAvaliacao(t,e,a){return m(this,null,function*(){e.submitting=!0;try{(yield this.avaliacaoDao.cancelarAvaliacao(t.avaliacao.id))&&(t.status="CONCLUIDO",t.avaliacao_id=null,t.avaliacao=void 0,a(t))}catch(i){e.error(i.message||i)}finally{e.submitting=!1}})}usuarioAssinou(t,e){return e=e||this.auth.usuario.id,Object.values(t).some(a=>(a||[]).includes(e))}assinaturasFaltantes(t,e){return{participante:t.participante.filter(a=>!e.participante.includes(a)),gestores_unidade_executora:t.gestores_unidade_executora.length?t.gestores_unidade_executora.filter(a=>e.gestores_unidade_executora.includes(a)).length?[]:t.gestores_unidade_executora:[],gestores_unidade_lotacao:t.gestores_unidade_lotacao.length?t.gestores_unidade_lotacao.filter(a=>e.gestores_unidade_lotacao.includes(a)).length?[]:t.gestores_unidade_lotacao:[],gestores_entidade:t.gestores_entidade.length?t.gestores_entidade.filter(a=>e.gestores_entidade.includes(a)).length?[]:t.gestores_entidade:[]}}};u.\u0275fac=function(e){return new(e||u)(d(D),d(h),d(p),d(f),d(_),d(O),d(A),d(_))},u.\u0275prov=g({token:u,factory:u.\u0275fac,providedIn:"root"});let l=u;return l})();export{L as a};
