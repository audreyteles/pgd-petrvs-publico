import{a as y,b as j}from"./chunk-3L5EFWZ5.js";import{Dc as U,Ec as L,Ic as M,Jc as x,Kc as P,Nd as q,O as k,R as f,Wc as B,h as S,xc as N}from"./chunk-SDCVQHKS.js";var ni=(()=>{let _=class _{constructor(i,n,s,c,r,g,u,p,V){this.lookup=i,this.lex=n,this.calendar=s,this.comentario=c,this.auth=r,this.util=g,this.go=u,this.dialog=p,this.dao=V,this.delete=(d,e)=>{this.dialog.confirm("Exclui ?","Deseja realmente excluir?").then(a=>{a&&this.dao.delete(e).then(()=>{d.removeId(e.id),this.dialog.topAlert("Registro exclu\xEDdo com sucesso!",5e3)}).catch(t=>this.dialog.alert("Erro","Erro ao excluir: "+(t?.message?t?.message:t)))})},this.cancelarInicio=(d,e)=>{this.dialog.confirm("Cancelar inicio ?","Deseja realmente cancelar a inicializa\xE7\xE3o?").then(a=>{a&&this.dao.cancelarInicio(e.id).then(()=>{d.refreshId(e.id),this.dialog.topAlert("Cancelado a inicializa\xE7\xE3o com sucesso!",5e3)}).catch(t=>this.dialog.alert("Erro","Erro ao cancelar inicio: "+t?.message?t?.message:t))})},this.cancelarConclusao=(d,e)=>{this.dialog.confirm("Cancelar conclus\xE3o ?","Deseja realmente cancelar a conclus\xE3o?").then(a=>{a&&this.dao.cancelarConclusao(e.id).then(()=>{d.refreshId(e.id),this.dialog.topAlert("Cancelado a conclus\xE3o com sucesso!",5e3)}).catch(t=>this.dialog.alert("Erro","Erro ao cancelar conclus\xE3o: "+t?.message?t?.message:t))})},this.desarquivar=(d,e)=>{this.dao.arquivar(e.id,!1).then(()=>{d.refreshId(e.id)}).catch(a=>this.dialog.alert("Erro","Erro ao cancelar inicio: "+a?.message?a?.message:a))},this.arquivar=(d,e)=>{this.dialog.confirm("Arquivar?","Deseja realmente arquivar a atividade?").then(a=>{a&&this.dao.arquivar(e.id,!0).then(()=>{d.refreshId(e.id)}).catch(t=>this.dialog.alert("Erro","Erro ao cancelar inicio: "+t?.message?t?.message:t))})},this.dynamicOptions=(d,e)=>{let a=[],t=d,b=this.auth.usuario?.id==t.unidade?.gestor?.id||t.unidade?.gestores_substitutos?.map(o=>o.id).includes(this.auth.usuario?.id||""),m=this.auth.usuario?.id==t.demandante_id,h=this.auth.usuario?.id==t.usuario_id,A=this.lastConsolidacao(d.metadados?.consolidacoes),I={label:"Informa\xE7\xF5es",icon:"bi bi-info-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"consult"]},{modal:!0})},C={label:"Coment\xE1rios",icon:"bi bi-chat-left-quote",onClick:o=>this.go.navigate({route:["uteis","comentarios","ATIVIDADE",o.id,"new"]},this.modalRefreshId(e,o))},D={label:"Clonar",icon:"bi bi-stickies",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"clonar"]},this.modalRefresh(e))},R={label:"Alterar atividade",icon:"bi bi-pencil-square",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"edit"]},this.modalRefreshId(e,o))},T={label:"Excluir atividade",icon:"bi bi-trash",onClick:this.delete.bind(this,e)},v={label:"Prorrogar prazo",icon:"bi bi-skip-end-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"prorrogar"]},this.modalRefreshId(e,o))},E={label:"Iniciar",id:"INICIADO",icon:"bi bi-play-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"iniciar"]},this.modalRefreshId(e,o))},l={label:"Cancelar inicio",id:"NAOINICIADO",icon:"bi bi-backspace",onClick:this.cancelarInicio.bind(this,e)},F={label:"Alterar inicio",icon:"bi bi-play-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"iniciar"]},this.modalRefreshId(e,o))},z={label:"Pausar",id:"PAUSADO",icon:"bi bi-pause-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"pausar"]},this.modalRefreshId(e,o))},Q={label:"Reiniciar",id:"INICIADO",icon:"bi bi-play-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"pausar"],params:{reiniciar:!0}},this.modalRefreshId(e,o))},G={label:"Concluir",id:"CONCLUIDO",icon:"bi bi-check-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"concluir"]},this.modalRefreshId(e,o))},H={label:"Alterar conclus\xE3o",icon:"bi bi-check-circle",onClick:o=>this.go.navigate({route:["gestao","atividade",o.id,"concluir"]},this.modalRefreshId(e,o))},X={label:"Cancelar conclus\xE3o",id:"INICIADO",icon:"bi bi-backspace",onClick:this.cancelarConclusao.bind(this,e)},J={label:"Arquivar",icon:"bi bi-inboxes",onClick:this.arquivar.bind(this,e)},Z={label:"Desarquivar",icon:"bi bi-reply",onClick:this.desarquivar.bind(this,e)};return e?.disabled||(a.push(I),(h||b||m)&&a.push(C),a.push(D),t.metadados?.arquivado?(b||h)&&a.push(Z):t.metadados?.iniciado?t.metadados?.concluido?((b||h)&&a.push(J),A?.status!="CONCLUIDO"&&((h||this.auth.hasPermissionTo("MOD_DMD_USERS_ALT_CONCL"))&&a.push(H),(h||this.auth.hasPermissionTo("MOD_DMD_USERS_CANC_CONCL"))&&(a.length&&a.push({divider:!0}),a.push(X)))):t.metadados?.iniciado&&(t.metadados?.pausado?(h||this.auth.hasPermissionTo("MOD_DMD_USERS_INICIAR"))&&a.push(Q):((h||this.auth.hasPermissionTo("MOD_DMD_USERS_CONCL"))&&a.push(G),(h||this.auth.hasPermissionTo("MOD_DMD_USERS_PAUSA"))&&a.push(z),(!A||A?.status=="INCLUIDO")&&((h||this.auth.hasPermissionTo("MOD_DMD_USERS_CANC_INICIAR"))&&a.push(l),(h||this.auth.hasPermissionTo("MOD_DMD_USERS_INICIAR"))&&a.push(F))),(b||m||this.auth.hasPermissionTo("MOD_DMD_USERS_PPRZO"))&&a.push(v)):((h||t.usuario_id==null||this.auth.hasPermissionTo("MOD_DMD_USERS_INICIAR"))&&a.push(E),(b||m||this.auth.hasPermissionTo("MOD_DMD_USERS_ALT"))&&a.push(R),(b||m||this.auth.hasPermissionTo("MOD_DMD_USERS_EXCL")||this.auth.hasPermissionTo("MOD_DMD_NI_EXCL"))&&(a.length&&a.push({divider:!0}),a.push(T)))),a},this.dynamicButtons=(d,e)=>{let a=[],t=d,b=this.auth.usuario?.id==t.unidade?.gestor?.id||t.unidade?.gestores_substitutos?.map(l=>l.usuario_id).includes(this.auth.usuario?.id||""),m=this.auth.usuario?.id==t.usuario_id,h=this.lastConsolidacao(d.metadados?.consolidacoes),A={hint:"Alterar avalia\xE7\xE3o",icon:"bi bi-check-all",color:"btn-outline-danger",onClick:l=>this.go.navigate({route:["gestao","atividade",l.id,"avaliar"]},this.modalRefreshId(e,l))},I={label:"Informa\xE7\xF5es",icon:"bi bi-info-circle",onClick:l=>this.go.navigate({route:["gestao","atividade",l.id,"consult"]},{modal:!0})},C={hint:"Iniciar",icon:"bi bi-play-circle",color:"btn-outline-secondary",onClick:l=>this.go.navigate({route:["gestao","atividade",l.id,"iniciar"]},this.modalRefreshId(e,l))},D={hint:"Reiniciar",icon:"bi bi-play-circle",color:"btn-outline-secondary",onClick:l=>this.go.navigate({route:["gestao","atividade",l.id,"pausar"],params:{reiniciar:!0}},this.modalRefreshId(e,l))},R={hint:"Concluir",icon:"bi bi-check",color:"btn-outline-success",onClick:l=>this.go.navigate({route:["gestao","atividade",l.id,"concluir"]},this.modalRefreshId(e,l))},T={hint:"Arquivar",icon:"bi bi-inboxes",onClick:this.arquivar.bind(this,e)},v={hint:"Desarquivar",icon:"bi bi-reply",onClick:this.desarquivar.bind(this,e)},E={hint:"Alterar conclus\xE3o",icon:"bi bi-check-circle",onClick:l=>this.go.navigate({route:["gestao","atividade",l.id,"concluir"]},this.modalRefreshId(e,l))};return e?.disabled||(t.metadados?.iniciado?t.metadados?.concluido?b||m?a.push(t.metadados?.arquivado?v:T):h?.status!="CONCLUIDO"&&(m||this.auth.hasPermissionTo("MOD_DMD_USERS_ALT_CONCL"))&&a.push(E):t.metadados?.iniciado&&(t.metadados?.pausado&&m?a.push(D):(m||this.auth.hasPermissionTo("MOD_DMD_USERS_CONCL"))&&a.push(R)):(m||t.usuario_id==null||this.auth.hasPermissionTo("MOD_DMD_USERS_INICIAR"))&&a.push(C)),a.length||a.push(I),a}}getStatus(i,n){let s=i,c=this.lookup.ATIVIDADE_STATUS.find(p=>p.key==s.status)||{key:"DESCONHECIDO",value:"Desconhecido",icon:"bi bi-question-circle",color:"light"},r=this.util.setTime(n?.data_inicio||new Date,0,0,0),g=this.util.setTime(n?.data_fim||new Date,23,59,59),u=[{data:{status:c.key,filter:!0},label:c.value,icon:c.icon,color:c.color}];return s.metadados?.atrasado&&u.push({data:{status:"ATRASADO",filter:!1},label:"Atrasado",icon:"bi bi-alarm",color:"danger"}),n&&(s.data_inicio&&this.util.asTimestamp(s.data_inicio)<this.util.asTimestamp(r)||s.data_entrega&&this.util.asTimestamp(s.data_entrega)>this.util.asTimestamp(g))&&u.push({data:{status:"EXTRAPOLADO",filter:!1},label:"Extrapolado",icon:"bi bi-arrow-left-right",color:"danger",hint:"Data de in\xEDcio ou conclus\xE3o "+this.lex.translate("da Atividade")+" extrapola os da consolida\xE7\xE3o"}),s.metadados?.arquivado&&u.push({data:{status:"ARQUIVADO",filter:!1},label:"Arquivado",icon:"bi bi-inboxes",color:"danger"}),s.metadados&&JSON.stringify(s.metadados._status)!=JSON.stringify(u)&&(s.metadados._status=u),s.metadados?._status||u}temposAtividade(i,n,s){if(i.metadados&&i.metadados.extra?.lastUpdate!=this.auth.unidadeHora){let c=n?.planos_trabalho[i.plano_trabalho_id]||i.plano_trabalho,r=[{color:"light",hint:this.lex.translate("Data de distribui\xE7\xE3o"),icon:"bi bi-file-earmark-plus",label:this.dao.getDateTimeFormatted(i.data_distribuicao)},{color:"light",hint:this.lex.translate("Prazo de entrega"),icon:"bi bi-calendar-check",label:this.dao.getDateTimeFormatted(i.data_estipulada_entrega)}];if(c?.tipo_modalidade?.atividade_esforco&&r.push({color:"light",hint:this.lex.translate("Esfor\xE7o"),icon:"bi bi-stopwatch",label:i.esforco?this.util.decimalToTimerFormated(i.esforco,!0)+" "+this.lex.translate("esfor\xE7o"):"Sem "+this.lex.translate("esfor\xE7o")}),i.metadados.concluido&&r.push({color:"light",hint:"Data de entrega realizada",icon:"bi bi-check-circle",label:this.dao.getDateTimeFormatted(i.data_entrega)}),i.metadados.iniciado&&c?.tipo_modalidade?.atividade_tempo_despendido){let g=c?.carga_horaria||0,u=n?.afastamentos[i.usuario_id]||[],p=i.metadados.concluido?i.tempo_despendido||0:this.calendar.horasUteis(i.data_inicio,this.auth.hora,g,i.unidade,"ENTREGA",i.pausas,u);r.push({color:p>i.esforco?"warning":"light",hint:"Tempo despendido",icon:"bi bi-hourglass-split",label:this.util.decimalToTimerFormated(p,!0)+" despendido",click:i.metadados.concluido?void 0:s,data:i})}if(!i.metadados.concluido&&this.util.asTimestamp(i.data_estipulada_entrega)<this.auth.hora.getTime()){let g=this.calendar.horasAtraso(i.data_estipulada_entrega,i.unidade);r.push({color:"danger",hint:"Tempo de atraso",icon:"bi bi-alarm",label:this.util.decimalToTimerFormated(g,!0)+" atrasado"})}i.metadados.extra=i.metadados.extra||{},i.metadados.extra.lastUpdate=this.auth.unidadeHora,i.metadados.extra.tempos=r}return i.metadados?.extra?.tempos||[]}onIdClick(i){this.util.copyToClipboard(i.toString())}buildEtiquetas(i,n){return this.util.merge(n?.etiquetas,i?.etiquetas,(s,c)=>s.key==c.key)}buildChecklist(i,n){let s=this.util.merge((i?.checklist||[]).map(c=>({id:c.key,texto:c.value,checked:!1})),(n?.value||[]).filter(c=>c.checked),(c,r)=>c.id==r.id?(c.checked=r.checked,!0):!1);return n&&n.setValue(s),s}comentarioAtividade(i,n){let s=n?.value||[],c=s.findIndex(r=>r.tipo=="TIPO_ATIVIDADE");if(c>=0&&(s[c]._status=="ADD"?s.splice(c,1):s[c]._status=="DELETE"),i?.comentario?.length){let r=new y;r.id=this.dao.generateUuid(),r.path="",r.texto=i.comentario,r.data_comentario=this.auth.hora,r.usuario_id=this.auth.usuario.id,r.comentario_id=null,r.tipo="TIPO_ATIVIDADE",r.usuario=this.auth.usuario,r._status="ADD",s.push(r),s=this.comentario.orderComentarios(s),n&&n.setValue(s)}}modalRefreshId(i,n){return{modal:!0,modalClose:s=>S(this,null,function*(){return i.refreshId(n.id)})}}modalRefresh(i){return{modal:!0,modalClose:i.refresh}}lastConsolidacao(i){return i?.reduce((n,s)=>n=!n||this.util.asTimestamp(s.data_conclusao)>this.util.asTimestamp(n.data_conclusao)?s:n,void 0)}};_.\u0275fac=function(n){return new(n||_)(f(M),f(P),f(x),f(j),f(B),f(U),f(N),f(L),f(q))},_.\u0275prov=k({token:_,factory:_.\u0275fac,providedIn:"root"});let O=_;return O})();export{ni as a};
