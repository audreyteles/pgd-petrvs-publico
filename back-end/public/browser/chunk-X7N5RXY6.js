import{a as Ge}from"./chunk-IGLI572K.js";import{a as te}from"./chunk-4FFFIQPI.js";import{a as Yt,b as ea}from"./chunk-J36J3DQU.js";import"./chunk-AEY7EVJX.js";import{a as Kt}from"./chunk-RXAJF325.js";import"./chunk-NN7U446Q.js";import{a as Nt,c as Wt,d as Me,e as Jt,h as $t,i as Xt,j as He,k as it,n as Zt}from"./chunk-ZLGBAEPE.js";import{d as Qe}from"./chunk-3L5EFWZ5.js";import{a as qe}from"./chunk-3OQ5NXFP.js";import{b as zt}from"./chunk-GEQ4G77C.js";import{a as B,b as H}from"./chunk-72ETMCRT.js";import{U as Bt,V as Ne,W as ze,X as Mt,Y as Qt,Z as Ht,_ as Gt,b as fe,ea as Be,f as le,fa as jt,g as Vt,h as L,i as be,j as Ut,n as ee,o as Le,p as kt,q as Lt,r as qt,s as M,t as Q,v as G,w as ve,x as se}from"./chunk-JEWU6XZO.js";import{b as Ve,c as Z,d as K,e as ge,h as Ue,j as Rt,m as Y,o as Ot,q as ke,r as Ft,s as k}from"./chunk-OWVQDN4P.js";import"./chunk-P4ZMML75.js";import{$c as oe,Ab as re,Bb as z,Dc as Ct,Fa as c,Fb as ft,Ga as d,Gd as It,Ha as m,Ia as ct,Id as St,Ja as mt,Jc as we,La as O,Ma as w,Mc as yt,Na as u,Nc as ue,Nd as At,O as lt,P as Ie,Pd as wt,R as st,Rc as Tt,Rd as he,Sc as $,Sd as Pt,U as F,Ua as y,V as Se,Va as T,Vc as _e,Wa as E,Xa as h,Ya as v,Z as I,Za as A,_ as S,_a as P,ab as pt,ad as Pe,ba as R,bb as ut,bd as Re,cd as Oe,da as dt,dd as Et,fd as X,g as rt,h as b,ic as gt,jb as _t,jd as xt,kb as N,lb as pe,ld as Dt,ma as s,mb as ht,na as V,oc as at,pc as bt,sb as f,tb as Ae,td as Fe,va as U,wc as vt,xa as _,ya as me,za as n}from"./chunk-SDCVQHKS.js";var ga=["usuario"],ba=["unidade"],va=["programa"],Ca=["tipoDocumento"],ya=["tipoModalidade"],aa=(()=>{let r=class r extends qe{constructor(e){super(e,oe,X),this.injector=e,this.validate=(a,t)=>{let l=null;return t=="tipo_documento_id"&&!a?.value?.length&&this.form?.controls?.numero_processo?.value?.length&&(l="Obrigat\xF3rio"),l},this.formValidation=a=>{if(!this.tipoDocumento?.selectedEntity&&a?.controls.tipo_documento_id.value?.length)return"Aguarde o carregamento do tipo de documento"},this.titleEdit=a=>"Editando "+this.lex.translate("TCR")+" "+this.lex.translate("do Plano de Trabalho")+": "+(a?.usuario?.nome||""),this.join=["unidade","usuario","programa.template_tcr","tipo_modalidade","documento","documentos","atividades.atividade"],this.unidadeDao=e.get($),this.programaDao=e.get(Re),this.usuarioDao=e.get(ue),this.tipoDocumentoDao=e.get(Dt),this.allPages=e.get(ke),this.tipoModalidadeDao=e.get(Pe),this.documentoDao=e.get(Fe),this.form=this.fh.FormBuilder({carga_horaria:{default:""},tempo_total:{default:""},tempo_proporcional:{default:""},data_inicio:{default:new Date},data_fim:{default:new Date},programa_id:{default:""},usuario_id:{default:""},unidade_id:{default:""},documento_id:{default:""},documentos:{default:[]},tipo_documento_id:{default:""},numero_processo:{default:""},vinculadas:{default:!0},tipo_modalidade_id:{default:""},forma_contagem_carga_horaria:{default:"DIA"}},this.cdRef,this.validate)}onVinculadasChange(e){this.cdRef.detectChanges()}loadData(e,a){return b(this,null,function*(){let t=Object.assign({},a.value);t=this.util.fillForm(t,e),yield Promise.all([this.unidade.loadSearch(e.unidade||e.unidade_id),this.usuario.loadSearch(e.usuario||e.usuario_id),this.programa.loadSearch(e.programa||e.programa_id),this.tipoModalidade.loadSearch(e.tipo_modalidade||e.tipo_modalidade_id)]),this.processo&&(t.id_processo=this.processo.id_processo,t.numero_processo=this.processo.numero_processo),t.data_inicio=this.auth.hora,a.patchValue(t)})}initializeData(e){return b(this,null,function*(){this.entity=yield this.dao.getById(this.metadata.plano_trabalho.id,this.join),this.processo=this.metadata?.processo,yield this.loadData(this.entity,e)})}saveData(e){return new Promise((a,t)=>{a(new vt(Object.assign(this.form.value,{codigo_tipo_documento:this.tipoDocumento?.selectedEntity?.codigo})))})}get formaContagemCargaHoraria(){let e=this.form?.controls.forma_contagem_carga_horaria?.value||"DIA";return e=="DIA"?"day":e=="SEMANA"?"week":"mouth"}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["plano-trabalho-form-termo"]],viewQuery:function(a,t){if(a&1&&(y(M,5),y(ga,5),y(ba,5),y(va,5),y(Ca,5),y(ya,5)),a&2){let l;T(l=E())&&(t.editableForm=l.first),T(l=E())&&(t.usuario=l.first),T(l=E())&&(t.unidade=l.first),T(l=E())&&(t.programa=l.first),T(l=E())&&(t.tipoDocumento=l.first),T(l=E())&&(t.tipoModalidade=l.first)}},features:[U],decls:25,vars:41,consts:[["programa",""],["usuario",""],["unidade",""],["tipoModalidade",""],["tipoDocumento",""],["initialFocus","programa_id",3,"submit","cancel","form","disabled","title"],["collapse","",3,"title","collapsed"],[1,"row"],["disabled","","controlName","programa_id",3,"size","dao"],["disabled","","controlName","usuario_id",3,"size","dao"],["disabled","","controlName","unidade_id",3,"size","dao"],["disabled","","controlName","tipo_modalidade_id",3,"size","dao"],["numbers","","disabled","","label","% prod.","icon","bi bi-hourglass-split","controlName","ganho_produtividade",3,"size","control","labelInfo"],["label","H. Parciais","icon","bi bi-clock","controlName","tempo_proporcional","labelInfo","Total de horas menos os afastamentos.",3,"size","control"],["disabled","","label","In\xEDcio","icon","bi bi-calendar-date","controlName","data_inicio","labelInfo","In\xEDcio da Vig\xEAncia do Programa",3,"size","control"],["disabled","","label","Final","icon","bi bi-calendar-date","controlName","data_fim","labelInfo","Final da Vig\xEAncia do Programa",3,"size","control"],["disabled","","label","C. Hor\xE1ria","icon","bi bi-hourglass-split","controlName","carga_horaria",3,"size","unit","control","labelInfo"],["label","H. Totais","icon","bi bi-clock","controlName","tempo_total","labelInfo","Horas \xFAteis de trabalho no per\xEDodo de vig\xEAncia considerando a carga hor\xE1ria, feriados e fins de semana",3,"size","control"],["disabled","","label","Data e hora","controlName","data_inicio","labelInfo","Data de cadastro do termo",3,"size","control"],["controlName","numero_processo","disabled","","labelInfo","N\xFAmero do processo, com a formata\xE7\xE3o de origem",3,"label","size","control"],["controlName","tipo_documento_id","required","",3,"size","disabled","dao"],["label","Vinculadas","controlName","vinculadas","labelInfo","Se inclui as atividades das unidades vinculadas a unidade do plano",3,"change","disabled","size","control"]],template:function(a,t){if(a&1){let l=O();c(0,"editable-form",5),w("submit",function(){return I(l),S(t.onSaveData())})("cancel",function(){return I(l),S(t.onCancel())}),c(1,"separator",6)(2,"div",7),m(3,"input-search",8,0)(5,"input-search",9,1),d(),c(7,"div",7),m(8,"input-search",10,2)(10,"input-search",11,3)(12,"input-text",12)(13,"input-display",13),d(),c(14,"div",7),m(15,"input-datetime",14)(16,"input-datetime",15)(17,"input-workload",16)(18,"input-display",17),d()(),c(19,"div",7),m(20,"input-datetime",18)(21,"input-text",19)(22,"input-search",20,4),c(24,"input-switch",21),w("change",function(g){return I(l),S(t.onVinculadasChange(g))}),d()()()}a&2&&(n("form",t.form)("disabled",t.formDisabled)("title",t.isModal?"":t.title),s(),n("title",t.lex.translate("Plano de trabalho"))("collapsed",!1),s(2),n("size",6)("dao",t.programaDao),s(2),n("size",6)("dao",t.usuarioDao),s(3),n("size",5)("dao",t.unidadeDao),s(2),n("size",3)("dao",t.tipoModalidadeDao),s(2),n("size",2)("control",t.form.controls.ganho_produtividade)("labelInfo","Percentual de ganho de produtividade (Ser\xE1 descontado do "+t.lex.translate("tempo pactuado")+")"),me("maxlength",250),s(),n("size",2)("control",t.form.controls.tempo_proporcional),s(2),n("size",3)("control",t.form.controls.data_inicio),s(),n("size",3)("control",t.form.controls.data_fim),s(),n("size",3)("unit",t.formaContagemCargaHoraria)("control",t.form.controls.carga_horaria)("labelInfo","Carga hor\xE1ria"+t.lex.translate("do usu\xE1rio")),s(),n("size",3)("control",t.form.controls.tempo_total),s(2),n("size",3)("control",t.form.controls.data_inicio),s(),n("label","N\xFAmero "+t.lex.translate("Processo"))("size",3)("control",t.form.controls.numero_processo),me("maxlength",250),s(),n("size",4)("disabled",t.form.controls.numero_processo.value!=null&&t.form.controls.numero_processo.value.length?void 0:"true")("dao",t.tipoDocumentoDao),s(2),n("disabled",!(t.entity==null||t.entity.atividades==null)&&t.entity.atividades.length?"true":void 0)("size",2)("control",t.form.controls.vinculadas))},dependencies:[M,ee,Vt,L,fe,le,Q,Ne]});let o=r;return o})();var xa=["origem"],Da=["planoEntrega"],Ia=["entrega"],nt=()=>["PROPRIA_UNIDADE","OUTRA_UNIDADE"],Sa=()=>["entregas.entrega:id,nome","unidade"],Aa=o=>["unidade_id","==",o],ia=()=>["status","==","ATIVO"],wa=(o,r)=>[o,r],Pa=o=>[o],Ra=o=>({unidade_id:o,status:"ATIVO"}),oa=o=>({filter:o}),Oa=()=>({status:"ATIVO"});function Fa(o,r){o&1&&(c(0,"div",22)(1,"span")(2,"strong"),v(3,"Origem"),d()()())}function Va(o,r){if(o&1&&m(0,"badge",31),o&2){let i=u().row,e=u();n("label",(i.plano_entrega_entrega==null||i.plano_entrega_entrega.plano_entrega==null||i.plano_entrega_entrega.plano_entrega.unidade==null?null:i.plano_entrega_entrega.plano_entrega.unidade.sigla)||"DESCONHECIDO")("icon",e.entityService.getIcon("Unidade"))}}function Ua(o,r){if(o&1&&m(0,"badge",32),o&2){let i=u().row;n("label",i.orgao)}}function ka(o,r){if(o&1&&(c(0,"div",26)(1,"div",27),m(2,"badge",28),_(3,Va,1,2,"badge",29)(4,Ua,1,1,"badge",30),d()()),o&2){let i=r.row,e=u();s(2),n("label",e.planoTrabalhoService.tipoEntrega(i,e.entity).titulo)("color",e.planoTrabalhoService.tipoEntrega(i,e.entity).cor),s(),n("ngIf",i.plano_entrega_entrega_id==null?null:i.plano_entrega_entrega_id.length),s(),n("ngIf",i.orgao==null?null:i.orgao.length)}}function La(o,r){if(o&1){let i=O();c(0,"input-search",36,15),w("change",function(a){I(i);let t=u(2);return S(t.onPlanoEntregaChange(a))}),d()}if(o&2){u();let i=h(1),e=u();n("placeholder","Selecione o "+e.lex.translate("Plano de entrega"))("join",N(5,Sa))("where",(i==null?null:i.value)=="PROPRIA_UNIDADE"?ht(9,wa,pe(6,Aa,e.entity==null?null:e.entity.unidade_id),N(8,ia)):pe(13,Pa,N(12,ia)))("selectParams",(i==null?null:i.value)=="PROPRIA_UNIDADE"?pe(17,oa,pe(15,Ra,e.entity==null?null:e.entity.unidade_id)):pe(20,oa,N(19,Oa)))("dao",e.planoEntregaDao)}}function qa(o,r){o&1&&m(0,"input-text",37,16),o&2&&me("maxlength",250)}function Na(o,r){if(o&1){let i=O();c(0,"input-select",33,14),w("change",function(){let a=I(i).row,t=u();return S(t.onOrigemChange(a))}),d(),_(2,La,2,22,"input-search",34)(3,qa,2,1,"input-text",35)}if(o&2){let i=h(1),e=u();n("control",e.form.controls.origem)("items",e.lookup.ORIGENS_ENTREGAS_PLANO_TRABALHO),s(2),n("ngIf",N(4,nt).includes(i==null?null:i.value)),s(),n("ngIf",(i==null?null:i.value)=="OUTRO_ORGAO")}}function za(o,r){o&1&&(c(0,"span")(1,"strong"),v(2,"Entrega"),d()())}function Ba(o,r){if(o&1&&(c(0,"div",40),m(1,"badge",41)(2,"badge",42),d()),o&2){let i=u().row,e=u();s(),n("label",e.util.getDateFormatted(i.plano_entrega_entrega==null?null:i.plano_entrega_entrega.data_inicio)),s(),n("label",e.util.getDateFormatted(i.plano_entrega_entrega==null?null:i.plano_entrega_entrega.data_fim))}}function Ma(o,r){if(o&1&&(c(0,"small"),v(1),d(),_(2,Ba,3,2,"div",38),m(3,"reaction",39)),o&2){let i=r.row,e=u();s(),A(e.planoTrabalhoService.tipoEntrega(i,e.entity).descricao),s(),n("ngIf",N(3,nt).includes(e.planoTrabalhoService.tipoEntrega(i,e.entity).tipo)),s(),n("entity",i)}}function Qa(o,r){if(o&1){let i=O();c(0,"input-select",44,17),w("change",function(a){I(i);let t=u(2);return S(t.onEntregaChange(a))}),d()}if(o&2){let i=u(2);n("control",i.form.controls.plano_entrega_entrega_id)("items",i.entregas)}}function Ha(o,r){if(o&1&&(c(0,"div",40),m(1,"badge",41)(2,"badge",42),d()),o&2){let i=u(2);s(),n("label",i.util.getDateFormatted(i.entrega.selectedItem.data.data_inicio)),s(),n("label",i.util.getDateFormatted(i.entrega.selectedItem.data.data_fim))}}function Ga(o,r){if(o&1&&_(0,Qa,2,2,"input-select",43)(1,Ha,3,2,"div",38),o&2){let i=u();n("ngIf",N(2,nt).includes(i.origem==null?null:i.origem.value)),s(),n("ngIf",i.entrega==null?null:i.entrega.selectedItem)}}function ja(o,r){if(o&1&&(c(0,"div")(1,"small"),m(2,"badge",46),d(),c(3,"small"),m(4,"badge",47),d()()),o&2){let i=u(2);s(2),n("color","warning")("label",i.totalForcaTrabalho+"%"),s(2),n("color","secondary")("label",i.totalForcaTrabalho-100+"%")}}function Wa(o,r){if(o&1&&(c(0,"small"),m(1,"badge",46),d()),o&2){let i=u(2);s(),n("color",i.totalForcaTrabalho==100?"success":"warning")("label",i.totalForcaTrabalho+"%")}}function Ja(o,r){if(o&1&&(c(0,"div",22),_(1,ja,5,4,"div",45)(2,Wa,2,2,"ng-template",null,18,f),d()),o&2){let i=h(3),e=u();s(),n("ngIf",e.totalForcaTrabalho>100)("ngIfElse",i)}}function $a(o,r){if(o&1&&(c(0,"small"),v(1),d()),o&2){let i=r.row;s(),A(i.forca_trabalho+"%")}}function Xa(o,r){if(o&1){let i=O();c(0,"input-text",48),w("change",function(){let a=I(i).row,t=u();return S(t.onForcaTrabalhoChange(a))}),d()}if(o&2){let i=u();n("control",i.form.controls.forca_trabalho),me("maxlength",250)}}function Za(o,r){o&1&&(c(0,"div",22)(1,"span")(2,"strong"),v(3,"Descri\xE7\xE3o dos Trabalhos"),d()()())}function Ka(o,r){if(o&1&&(c(0,"div")(1,"small"),v(2),d()()),o&2){let i=u().row;s(2),A(i.descricao)}}function Ya(o,r){if(o&1&&_(0,Ka,3,1,"div",45),o&2){let i=r.row,e=u(),a=h(30);n("ngIf",i.descricao!=e.planoTrabalhoService.tipoEntrega(i,e.entity).descricao)("ngIfElse",a)}}function ei(o,r){o&1&&(c(0,"small"),v(1,"Detalhe/Descreva os trabalhos"),d())}function ti(o,r){if(o&1&&m(0,"input-textarea",49),o&2){let i=u();n("rows",2)("control",i.form.controls.descricao)}}var ye=(()=>{let r=class r extends Y{set control(e){super.control=e}get control(){return super.control}set entity(e){super.entity=e}get entity(){return super.entity}set disabled(e){this._disabled!=e&&(this._disabled=e)}get disabled(){return this._disabled}set noPersist(e){super.noPersist=e}get noPersist(){return super.noPersist}set planoTrabalhoEditavel(e){this._planoTrabalhoEditavel!=e&&(this._planoTrabalhoEditavel=e)}get planoTrabalhoEditavel(){return this._planoTrabalhoEditavel}get items(){return this.gridControl.value||this.gridControl.setValue(new oe),this.gridControl.value.entregas||(this.gridControl.value.entregas=[]),this.gridControl.value.entregas}constructor(e){super(e),this.injector=e,this.atualizaPlanoTrabalhoEvent=new dt,this.options=[],this.totalForcaTrabalho=0,this.entregas=[],this._disabled=!1,this._planoTrabalhoEditavel=!0,this.validate=(a,t)=>{let l=null;return["forca_trabalho"].indexOf(t)>=0&&a.value==1||(["forca_trabalho"].indexOf(t)>=0&&!a.value&&(l="Obrigat\xF3rio!"),["descricao"].indexOf(t)>=0&&!a.value?.length&&(l="Obrigat\xF3rio!"),["forca_trabalho"].indexOf(t)>=0&&(a.value<1||a.value>100)&&(l="Deve estar entre 1 e 100"),["plano_entrega_entrega_id"].indexOf(t)>=0&&(["PROPRIA_UNIDADE","OUTRA_UNIDADE"].includes(this.form?.controls.origem.value)&&!a.value&&(l="Obrigat\xF3rio!"),this.entity?.entregas?.filter(p=>!!p.plano_entrega_entrega_id&&p.id!=this.grid?.editing?.id).find(p=>p.plano_entrega_entrega_id==a.value)&&(l="Esta entrega est\xE1 em duplicidade!"))),l},this.dao=e.get(Et),this.cdRef=e.get(Ae),this.planoTrabalhoDao=e.get(X),this.planoEntregaDao=e.get(Tt),this.planoTrabalhoService=e.get(te),this.peeDao=e.get(Oe),this.unidadeService=e.get(_e),this.join=["entrega","plano_entrega_entrega.entrega","plano_entrega_entrega.plano_entrega:id,unidade_id","plano_entrega_entrega.plano_entrega.unidade:id,sigla"],this.form=this.fh.FormBuilder({origem:{default:null},orgao:{default:null},descricao:{default:""},forca_trabalho:{default:1},plano_trabalho_id:{default:null},plano_entrega_id:{default:null},plano_entrega_entrega_id:{default:null}},this.cdRef,this.validate)}validateEntregas(){let e={start:this.entity.data_inicio,end:this.entity.data_fim};for(let a of this.items){let t=a.plano_entrega_entrega;if(t){let l=t.data_fim?t.data_fim:t.data_inicio.getTime()<=this.entity.data_fim.getTime()?this.entity.data_fim:void 0,p={start:t.data_inicio,end:t.data_fim||t.data_inicio};if(!l||!this.util.intersection([p,e]))return this.lex.translate("Entrega")+" "+t.descricao+" possui datas incompat\xEDveis (in\xEDcio "+this.util.getDateFormatted(t.data_inicio)+(t.data_fim?"e fim "+this.util.getDateFormatted(t.data_fim):"")+")"}}}ngOnInit(){return b(this,null,function*(){rt(r.prototype,this,"ngOnInit").call(this),this.entity=this.metadata?.entity||this.entity,this.totalForcaTrabalho=Math.round(this.somaForcaTrabalho(this.entity?.entregas)*100)/100,this.entity._metadata=this.entity._metadata||{},this.entity._metadata.novaEntrega=void 0})}addEntrega(){return b(this,null,function*(){return Object.assign(new St,{_status:"ADD",id:this.dao.generateUuid(),plano_trabalho_id:this.entity?.id})})}loadEntrega(e,a){return b(this,null,function*(){let t=a;if(e.controls.descricao.setValue(a.descricao),e.controls.forca_trabalho.setValue(a.forca_trabalho),e.controls.plano_trabalho_id.setValue(a.plano_trabalho_id),e.controls.orgao.setValue(null),e.controls.plano_entrega_entrega_id.setValue(null),a.plano_entrega_entrega&&(e.controls.plano_entrega_id.setValue(a.plano_entrega_entrega.plano_entrega.id),e.controls.plano_entrega_entrega_id.setValue(a.plano_entrega_entrega_id)),t._status=="ADD"&&!e.controls.plano_entrega_id.value){e.controls.origem.setValue("PROPRIA_UNIDADE");let l=yield this.planoEntregaDao.query({where:[["unidade_id","==",this.entity.unidade_id],["status","==","ATIVO"]]}).asPromise();e.controls.plano_entrega_id.setValue(l[0].id)}else t.plano_entrega_entrega?.plano_entrega?.unidade_id==this.entity.unidade_id?(e.controls.origem.setValue("PROPRIA_UNIDADE"),yield this.carregarEntregas(t.plano_entrega_entrega.plano_entrega_id),e.controls.plano_entrega_entrega_id.setValue(t.plano_entrega_entrega_id)):t.plano_entrega_entrega?(e.controls.origem.setValue("OUTRA_UNIDADE"),yield this.carregarEntregas(t.plano_entrega_entrega.plano_entrega_id),e.controls.plano_entrega_entrega_id.setValue(t.plano_entrega_entrega_id)):t.orgao?.length?(e.controls.origem.setValue("OUTRO_ORGAO"),e.controls.orgao.setValue(t.orgao)):e.controls.origem.setValue("SEM_ENTREGA")})}removeEntrega(e){return b(this,null,function*(){if(yield this.dialog.confirm("Exclui ?","Deseja realmente excluir?")){this.loading=!0;try{this.isNoPersist?Object.assign(e,{_status:"DELETE"}):yield this.dao?.delete(e.id)}finally{this.loading=!1,this.atualizaPlanoTrabalhoEvent.emit(this.entity.id)}return this.totalForcaTrabalho=Math.round((this.totalForcaTrabalho-e.forca_trabalho*1)*100)/100,!this.isNoPersist}else return!1})}saveEntrega(e,a){return b(this,null,function*(){this.entity._metadata=this.entity._metadata||{},this.entity._metadata.novaEntrega=a,this.entity._metadata.novaEntrega.plano_entrega_entrega_id=this.form?.controls.plano_entrega_entrega_id.value,this.entity._metadata.novaEntrega.orgao=this.form?.controls.orgao.value,this.entity._metadata.novaEntrega.descricao=this.form?.controls.descricao.value,this.entity._metadata.novaEntrega.forca_trabalho=this.form?.controls.forca_trabalho.value,this.loading=!0;try{this.isNoPersist||(yield this.dao.save(this.entity._metadata.novaEntrega,this.join))}catch(t){this.error(t.message?t.message:t.toString()||t)}finally{a.forca_trabalho=this.form?.controls.forca_trabalho.value*1,a.plano_entrega_entrega=this.entrega?.selectedItem?.data||null,this.totalForcaTrabalho=Math.round(this.somaForcaTrabalho(this.entity?.entregas)*100)/100,this.loading=!1}return this.entity._metadata.novaEntrega})}saveEndEntrega(e){this.entity._metadata=null,this.atualizaPlanoTrabalhoEvent.emit(this.entity.id)}somaForcaTrabalho(e=[]){return e.map(a=>a.forca_trabalho*1).reduce((a,t)=>a+t,0)}carregarEntregas(e){return b(this,null,function*(){let a=typeof e=="string"?yield this.planoEntregaDao.getById(e,["entregas.entrega:id,nome","unidade"]):e,t={id:a?.id,unidade_id:a?.unidade_id,unidade:a?.unidade};this.entregas=a?.entregas.map(l=>Object.assign({},{key:l.id,value:l.descricao||l.entrega?.nome||"Desconhecido",data:Object.assign(l,{plano_entrega:t})}))||[],this.entregas.sort((l,p)=>l.value>p.value?1:-1),this.entregas.find(l=>l.key==this.form.controls.plano_entrega_entrega_id.value)||this.form.controls.plano_entrega_entrega_id.setValue(null)})}onOrigemChange(e){return b(this,null,function*(){let a=this.form.controls.origem.value;this.cdRef.detectChanges(),a=="OUTRO_ORGAO"?this.form?.controls.plano_entrega_entrega_id.setValue(null):a=="SEM_ENTREGA"?(this.form?.controls.orgao.setValue(null),this.form?.controls.plano_entrega_entrega_id.setValue(null)):a=="OUTRA_UNIDADE"&&(this.form?.controls.orgao.setValue(null),this.form?.controls.plano_entrega_id.value||(this.loading=!0,this.planoEntrega?.onSelectClick(new Event("SELECT")),this.loading=!1))})}onPlanoEntregaChange(e){let a=this.planoEntrega?.selectedEntity;this.carregarEntregas(a)}onEntregaChange(e){}onForcaTrabalhoChange(e){let a=this.items.findIndex(t=>t.id==e.id);this.totalForcaTrabalho=Math.round((this.somaForcaTrabalho(this.grid?.items)-this.items[a].forca_trabalho*1+this.form?.controls.forca_trabalho.value*1)*100)/100}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["plano-trabalho-list-entrega"]],viewQuery:function(a,t){if(a&1&&(y(M,5),y(k,5),y(xa,5),y(Da,5),y(Ia,5)),a&2){let l;T(l=E())&&(t.editableForm=l.first),T(l=E())&&(t.grid=l.first),T(l=E())&&(t.origem=l.first),T(l=E())&&(t.planoEntrega=l.first),T(l=E())&&(t.entrega=l.first)}},inputs:{control:"control",entity:"entity",disabled:"disabled",noPersist:"noPersist",cdRef:"cdRef",planoTrabalhoEditavel:"planoTrabalhoEditavel"},outputs:{atualizaPlanoTrabalhoEvent:"atualizaPlanoTrabalhoEvent"},features:[U],decls:34,vars:39,consts:[["gridEntregas",""],["titleOrigem",""],["columnOrigem",""],["editOrigem",""],["titleEntrega",""],["columnEntrega",""],["editEntrega",""],["titleForcaTrabalho",""],["columnForcaTrabalho",""],["editForcaTrabalho",""],["titleDescricao",""],["columnDescricao",""],["solicitarDescricao",""],["editDescricao",""],["origem",""],["planoEntrega",""],["orgao",""],["entrega",""],["umCHD",""],["noMargin","","editable","",3,"items","form","selectable","minHeight","join","groupBy","add","remove","save","load","saveEnd","hasDelete","hasEdit","hasAdd"],[3,"titleTemplate","template","editTemplate","verticalAlign","width","align"],[3,"width","titleTemplate","template","editTemplate","verticalAlign"],[1,"text-center"],[3,"titleTemplate","title","template","editTemplate","width","align","titleHint"],[3,"minWidth","maxWidth","titleTemplate","template","editTemplate","verticalAlign","align"],["type","options"],[1,"w-100","d-flex","justify-content-center"],[1,"one-per-line"],[3,"label","color"],["color","primary",3,"label","icon",4,"ngIf"],["icon","bi bi-box-arrow-down-left","color","warning",3,"label",4,"ngIf"],["color","primary",3,"label","icon"],["icon","bi bi-box-arrow-down-left","color","warning",3,"label"],["controlName","origem","controlName","origem",3,"change","control","items"],["label","","controlName","plano_entrega_id",3,"placeholder","join","where","selectParams","dao","change",4,"ngIf"],["controlName","orgao","placeholder","\xD3rg\xE3o",4,"ngIf"],["label","","controlName","plano_entrega_id",3,"change","placeholder","join","where","selectParams","dao"],["controlName","orgao","placeholder","\xD3rg\xE3o"],["class","w-100",4,"ngIf"],["origem","PLANO_TRABALHO_ENTREGA",3,"entity"],[1,"w-100"],["color","light","icon","bi bi-box-arrow-in-right","hint","Data de in\xEDcio",3,"label"],["color","light","icon","bi bi-box-arrow-right","hint","Data de t\xE9rmino",3,"label"],["nullable","","itemNull","- Selecione -","controlName","plano_entrega_entrega_id",3,"control","items","change",4,"ngIf"],["nullable","","itemNull","- Selecione -","controlName","plano_entrega_entrega_id",3,"change","control","items"],[4,"ngIf","ngIfElse"],["icon","bi bi-calculator",3,"color","label"],["icon","bi bi-intersect",3,"color","label"],["number","","sufix","%","controlName","forca_trabalho",3,"change","control"],["controlName","descricao",3,"rows","control"]],template:function(a,t){if(a&1&&(c(0,"grid",19,0)(2,"columns")(3,"column",20),_(4,Fa,4,0,"ng-template",null,1,f)(6,ka,5,4,"ng-template",null,2,f)(8,Na,4,5,"ng-template",null,3,f),d(),c(10,"column",21),_(11,za,3,0,"ng-template",22,4,f)(13,Ma,4,4,"ng-template",null,5,f)(15,Ga,2,3,"ng-template",null,6,f),d(),c(17,"column",23),_(18,Ja,4,2,"ng-template",null,7,f)(20,$a,2,1,"ng-template",null,8,f)(22,Xa,1,2,"ng-template",null,9,f),d(),c(24,"column",24),_(25,Za,4,0,"ng-template",null,10,f)(27,Ya,1,2,"ng-template",null,11,f)(29,ei,2,0,"ng-template",null,12,f)(31,ti,1,2,"ng-template",null,13,f),d(),m(33,"column",25),d()()),a&2){let l=h(5),p=h(7),g=h(9),D=h(12),C=h(14),q=h(16),x=h(19),j=h(21),ie=h(23),de=h(26),Ee=h(28),ne=h(32);n("items",t.items)("form",t.form)("selectable",!1)("minHeight",t.items.length>2?0:300)("join",t.join)("groupBy",t.groupBy)("add",t.addEntrega.bind(t))("remove",t.removeEntrega.bind(t))("save",t.saveEntrega.bind(t))("load",t.loadEntrega.bind(t))("saveEnd",t.saveEndEntrega.bind(t))("hasDelete",!t.disabled&&t.planoTrabalhoEditavel)("hasEdit",!t.disabled&&t.planoTrabalhoEditavel)("hasAdd",!t.disabled&&t.planoTrabalhoEditavel),s(3),n("titleTemplate",l)("template",p)("editTemplate",g)("verticalAlign","middle")("width",300)("align","center"),s(7),n("width",350)("titleTemplate",D)("template",C)("editTemplate",q)("verticalAlign","middle"),s(7),n("titleTemplate",x)("title","% CHD")("template",j)("editTemplate",ie)("width",100)("align","center")("titleHint","% Carga Hor\xE1ria Dispon\xEDvel"),s(7),n("minWidth",150)("maxWidth",250)("titleTemplate",de)("template",Ee)("editTemplate",ne)("verticalAlign","middle")("align","center")}},dependencies:[z,k,K,Z,L,fe,Le,be,G,Be]});let o=r;return o})();var ii=["gridAtividades"],oi=["gridDocumentos"],ni=["tabs"],ri=["usuario"],li=["programa"],si=["unidade"],di=["tipoModalidade"],ci=["planoEntrega"],mi=["atividade"],pi=["entrega"],ui=["documentos"],_i=()=>["afastamentos","lotacao","unidades","participacoes_programas"],hi=()=>["usuario_id"],fi=()=>["usuario_id","programa_id","tipo_modalidade_id"];function gi(o,r){if(o&1&&(c(0,"separator",27),m(1,"calendar-efemerides",28),d()),o&2){let i=u(2);s(),n("efemerides",i.horasTotais)("partial",!1)}}function bi(o,r){if(o&1&&(c(0,"separator",29),m(1,"calendar-efemerides",30),d()),o&2){let i=u(2);s(),n("efemerides",i.horasParciais)}}function vi(o,r){if(o&1){let i=O();ct(0),c(1,"div",9)(2,"input-workload",22),w("change",function(a){I(i);let t=u();return S(t.onCargaHorariaChenge(a))}),d(),m(3,"input-timer",23)(4,"input-timer",24),d(),_(5,gi,2,2,"separator",25)(6,bi,2,1,"separator",26),mt()}if(o&2){let i=u();s(2),n("size",4)("unit",i.formaContagemCargaHoraria)("control",i.form.controls.carga_horaria)("unitChange",i.onFormaContagemCargaHorariaChange.bind(i)),s(),n("size",4)("control",i.form.controls.tempo_total),s(),n("size",4)("control",i.form.controls.tempo_proporcional),s(),n("ngIf",i.horasTotais),s(),n("ngIf",i.horasParciais)}}function Ci(o,r){if(o&1&&m(0,"top-alert",31),o&2){let i=u();n("message","Antes de incluir "+i.lex.translate("entrega")+" neste "+i.lex.translate("Plano de Trabalho")+", \xE9 necess\xE1rio selecionar "+i.lex.translate("a Unidade")+" e  o "+i.lex.translate("Programa")+"!")}}function yi(o,r){if(o&1&&(c(0,"div"),m(1,"plano-trabalho-list-entrega",32),d()),o&2){let i=u();s(),n("disabled",i.formDisabled)("entity",i.entity)}}function Ti(o,r){if(o&1&&(c(0,"tab",33)(1,"separator",18),m(2,"input-switch",34)(3,"input-editor",35),d(),c(4,"separator",36),m(5,"input-switch",37)(6,"input-editor",38),d()()),o&2){let i=u();n("label",i.lex.translate("Texto Complementar")),s(),n("title","Texto complementar da "+i.lex.translate("unidade")),s(),n("disabled",i.podeEditarTextoComplementar(i.form.controls.unidade_id.value))("size",12)("label","Editar texto complementar "+i.lex.translate("na unidade")),s(),n("disabled",i.form.controls.editar_texto_complementar_unidade.value?void 0:"true")("dataset",i.planoDataset),s(2),n("disabled",i.podeEditarTextoComplementar(i.form.controls.unidade_id.value))("size",12)("label","Editar texto complementar "+i.lex.translate("do usu\xE1rio")),s(),n("disabled",i.form.controls.editar_texto_complementar_usuario.value?void 0:"true")("dataset",i.planoDataset)}}function Ei(o,r){if(o&1&&(c(0,"tab",39)(1,"div",40),m(2,"documentos",41,5),d()()),o&2){let i=u(),e=h(12);n("label",i.lex.translate("Termo")),s(2),n("entity",i.entity)("disabled",i.formDisabled)("cdRef",i.cdRef)("needSign",i.planoTrabalhoService.needSign)("extraTags",i.planoTrabalhoService.extraTags)("editingId",i.formDisabled?void 0:i.editingId)("datasource",i.datasource)("template",e==null||e.selectedEntity==null?null:e.selectedEntity.template_tcr)}}var Xe=(()=>{let r=class r extends qe{constructor(e){super(e,oe,X),this.injector=e,this.entregas=[],this.gestoresUnidadeExecutora=[],this.validate=(a,t)=>{let l=null;return["unidade_id","programa_id","usuario_id","tipo_modalidade_id"].indexOf(t)>=0&&!a.value?.length?l="Obrigat\xF3rio":["carga_horaria"].indexOf(t)>=0&&!a.value?l="Valor n\xE3o pode ser zero.":["data_inicio","data_fim"].includes(t)&&!this.util.isDataValid(a.value)?l="Inv\xE1lido":t=="data_fim"&&this.util.isDataValid(this.form?.controls.data_inicio.value)&&this.util.asTimestamp(a.value)<=this.util.asTimestamp(this.form.controls.data_inicio.value)?l="Menor que o in\xEDcio":this.programa&&t=="data_inicio"&&a.value.getTime()<this.programa.selectedEntity?.data_inicio.getTime()?l="Menor que programa":this.programa&&t=="data_fim"&&a.value.getTime()>this.programa.selectedEntity?.data_fim.getTime()&&(l="Maior que programa"),l},this.formValidation=a=>b(this,null,function*(){return""}),this.titleEdit=a=>"Editando "+this.lex.translate("Plano de Trabalho")+": "+(a?.usuario?.apelido||""),this.join=["unidade.entidade","entregas.entrega","entregas.plano_entrega_entrega:id,plano_entrega_id","usuario","programa.template_tcr","tipo_modalidade","documento","documentos.assinaturas.usuario:id,nome,apelido","entregas.plano_entrega_entrega.entrega","entregas.plano_entrega_entrega.plano_entrega.unidade:id,nome,sigla","entregas.reacoes.usuario:id,nome,apelido"],this.joinPrograma=["template_tcr"],this.programaDao=e.get(Re),this.usuarioDao=e.get(ue),this.unidadeDao=e.get($),this.documentoService=e.get(Ft),this.templateService=e.get(Ot),this.utilService=e.get(Ct),this.calendar=e.get(we),this.allPages=e.get(ke),this.tipoModalidadeDao=e.get(Pe),this.documentoDao=e.get(Fe),this.planoTrabalhoService=e.get(te),this.modalWidth=1300,this.planoDataset=this.dao.dataset(),this.form=this.fh.FormBuilder({carga_horaria:{default:""},tempo_total:{default:""},tempo_proporcional:{default:""},data_inicio:{default:new Date},data_fim:{default:new Date},usuario_id:{default:""},unidade_id:{default:""},programa_id:{default:""},documento_id:{default:null},documentos:{default:[]},atividades:{default:[]},entregas:{default:[]},tipo_modalidade_id:{default:""},forma_contagem_carga_horaria:{default:"DIA"},editar_texto_complementar_unidade:{default:!1},editar_texto_complementar_usuario:{default:!1},unidade_texto_complementar:{default:""},usuario_texto_complementar:{default:""},criterios_avaliacao:{default:[]},criterio_avaliacao:{default:""}},this.cdRef,this.validate),this.programaMetadata={todosUnidadeExecutora:!0,vigentesUnidadeExecutora:!1}}ngOnInit(){super.ngOnInit();let e=(this.url?this.url[this.url.length-1]?.path:"")||"";this.action=["termos"].includes(e)?e:this.action,this.buscaGestoresUnidadeExecutora(this.entity?.unidade??null)}atualizarTcr(){this.entity=this.loadEntity();let e=this.form.controls.usuario_texto_complementar.value,a=this.form.controls.unidade_texto_complementar.value,t=this.planoTrabalhoService.atualizarTcr(this.planoTrabalho,this.entity,e,a);this.form?.controls.documento_id.setValue(t?.id),this.form?.controls.documentos.setValue(this.entity.documentos),this.datasource=t?.datasource||{},this.template=this.entity.programa?.template_tcr,this.editingId=["ADD","EDIT"].includes(t?._status||"")?t.id:void 0,this.cdRef.detectChanges()}get isTermos(){return this.action=="termos"}onUnidadeSelect(e){let a=this.unidade?.selectedEntity;this.entity.unidade=a,this.entity.unidade_id=a.id,this.form.controls.forma_contagem_carga_horaria.setValue(a?.entidade?.forma_contagem_carga_horaria||"DIA"),this.form.controls.unidade_texto_complementar.setValue(a?.texto_complementar_plano||""),this.unidadeDao.getById(a.id,["gestor:id,usuario_id","gestores_substitutos:id,usuario_id","gestores_delegados:id,usuario_id"]).then(t=>{this.buscaGestoresUnidadeExecutora(t)})}podeEditarTextoComplementar(e){return e==this.auth.unidadeGestor()?.id?void 0:"true"}onProgramaSelect(e){let a=e.entity;this.entity.programa_id=a.id,this.entity.programa=a,this.form?.controls.criterios_avaliacao.setValue(a.plano_trabalho_criterios_avaliacao||[]),this.form?.controls.data_inicio.updateValueAndValidity(),this.form?.controls.data_fim.updateValueAndValidity(),this.calculaTempos(),this.cdRef.detectChanges()}onUsuarioSelect(e){this.form.controls.usuario_texto_complementar.setValue(e.entity?.texto_complementar_plano||""),this.form?.controls.unidade_id.value||e.entity.unidades?.every(a=>b(this,null,function*(){if(e.entity.lotacao.unidade_id==a.id){if(!this.form?.controls.programa_id.value){let t=a.path.split("/").reverse(),l=new Date,p=0,g=0;for(;p==0;)yield this.programaDao.query({where:[["vigentesUnidadeExecutora","==",this.auth.unidade.id]]}).asPromise().then(D=>{D.length>0&&p==0&&(p=1,this.preencheUnidade(a),this.preenchePrograma(D[0]))}),g+=1}return!1}else return!0})),this.calculaTempos(),this.cdRef.detectChanges()}preencheUnidade(e){this.form?.controls.unidade_id.setValue(e.id),this.entity.unidade=e,this.entity.unidade_id=e.id,this.form.controls.forma_contagem_carga_horaria.setValue(e?.entidade?.forma_contagem_carga_horaria||"DIA"),this.form.controls.unidade_texto_complementar.setValue(e?.texto_complementar_plano||""),this.unidadeDao.getById(e.id,["gestor:id,usuario_id","gestores_substitutos:id,usuario_id","gestores_delegados:id,usuario_id"]).then(a=>{this.buscaGestoresUnidadeExecutora(a)})}preenchePrograma(e){this.form?.controls.programa_id.setValue(e.id),this.entity.programa_id=e.id,this.entity.programa=e,this.form?.controls.criterios_avaliacao.setValue(e.plano_trabalho_criterios_avaliacao||[]),this.form?.controls.data_inicio.updateValueAndValidity(),this.form?.controls.data_fim.updateValueAndValidity()}onDataInicioChange(e){this.calculaTempos()}onDataFimChange(e){this.calculaTempos()}onCargaHorariaChenge(e){this.calculaTempos()}calculaTempos(){let e=this.form?.controls.data_inicio.value,a=this.form?.controls.data_fim.value,t=this.form?.controls.carga_horaria.value||8,l=this.usuario?.selectedEntity,p=this.unidade?.selectedEntity;l&&p&&this.util.isDataValid(e)&&this.util.isDataValid(a)&&this.util.asTimestamp(e)<this.util.asTimestamp(a)&&this.calendar.loadFeriadosCadastrados(p.id).then(g=>{this.horasTotais=this.calendar.calculaDataTempoUnidade(e,a,t,p,"ENTREGA",[],[]),this.horasParciais=this.calendar.calculaDataTempoUnidade(e,a,t,p,"ENTREGA",[],l.afastamentos),this.form?.controls.tempo_total.setValue(this.horasTotais.tempoUtil),this.form?.controls.tempo_proporcional.setValue(this.horasParciais.tempoUtil)})}loadData(e,a){return b(this,null,function*(){this.planoTrabalho=new oe(e),yield Promise.all([this.calendar.loadFeriadosCadastrados(e.unidade_id),this.usuario?.loadSearch(e.usuario||e.usuario_id),this.unidade?.loadSearch(e.unidade||e.unidade_id),this.programa?.loadSearch(e.programa||e.programa_id),this.tipoModalidade?.loadSearch(e.tipo_modalidade||e.tipo_modalidade_id)]);let t=Object.assign({},a.value);a.patchValue(this.util.fillForm(t,e)),this.calculaTempos(),this.atualizarTcr()})}initializeData(e){return b(this,null,function*(){if(this.isTermos)this.entity=yield this.dao.getById(this.urlParams.get("id"),this.join);else{this.entity=new oe,this.entity.carga_horaria=this.auth.entidade?.carga_horaria_padrao||8,this.entity.forma_contagem_carga_horaria=this.auth.entidade?.forma_contagem_carga_horaria||"DIA",this.entity.unidade_id=this.auth.unidade.id;let t=yield this.programaDao.query({where:[["vigentesUnidadeExecutora","==",this.auth.unidade.id]],join:this.joinPrograma}).asPromise(),l=t[t.length-1];this.preenchePrograma(l),this.buscaGestoresUnidadeExecutora(this.auth.unidade),this.gestoresUnidadeExecutora.includes(this.auth.unidade.id)||(this.entity.usuario_id=this.auth.usuario.id)}yield this.loadData(this.entity,this.form);let a=new Date;a.setHours(0,0,0,0),this.form?.controls.data_inicio.setValue(a),this.form?.controls.data_fim.setValue("")})}loadEntity(){let e=this.util.fill(new oe,this.entity);return e=this.util.fillForm(e,this.form.value),e.usuario=this.usuario.selectedEntity||this.entity?.usuario,e.unidade=this.unidade?.selectedEntity||this.entity?.unidade,e.programa=this.programa?.selectedEntity||this.entity?.programa,e.tipo_modalidade=this.tipoModalidade.selectedEntity||this.entity?.tipo_modalidade,e}saveData(e){return b(this,null,function*(){this.submitting=!0;try{this.atualizarTcr(),this.documentos?.saveData(),this.submitting=!0,this.entity.documentos=this.entity.documentos.filter(l=>["ADD","EDIT","DELETE"].includes(l._status||""));let a=[this.dao.save(this.entity,this.join)];this.form.controls.editar_texto_complementar_unidade.value&&a.push(this.unidadeDao.update(this.entity.unidade_id,{texto_complementar_plano:this.form.controls.unidade_texto_complementar.value})),this.form.controls.editar_texto_complementar_usuario.value&&a.push(this.usuarioDao.update(this.entity.usuario_id,{texto_complementar_plano:this.form.controls.usuario_texto_complementar.value}));let t=yield Promise.all(a);this.entity=t[0]}finally{this.submitting=!1}return!0})}onTabSelect(e){e.key=="TERMO"&&this.atualizarTcr()}documentoDynamicButtons(e){let a=[],t=e;return this.isTermos&&this.planoTrabalhoService.needSign(this.entity,t)&&a.push({hint:"Assinar",icon:"bi bi-pen",onClick:this.signDocumento.bind(this)}),a.push({hint:"Preview",icon:"bi bi-zoom-in",onClick:(l=>{this.dialog.html({title:"Termo de ades\xE3o",modalWidth:1e3},l.conteudo||"")}).bind(this)}),a}signDocumento(e){return b(this,null,function*(){yield this.documentoService.sign([e]),this.cdRef.detectChanges()})}get formaContagemCargaHoraria(){let e=this.form?.controls.forma_contagem_carga_horaria.value||"DIA";return e=="DIA"?"day":e=="SEMANA"?"week":"mouth"}onFormaContagemCargaHorariaChange(e){this.form.controls.forma_contagem_carga_horaria.setValue(e=="day"?"DIA":e=="week"?"SEMANA":"MES")}isVigente(e){return this.form.controls.documento_id.value==e.id}buscaGestoresUnidadeExecutora(e){return e&&[e.gestor?.usuario_id,...e.gestores_substitutos?.map(a=>a.usuario_id),...e.gestores_delegados?.map(a=>a.usuario_id)].forEach(a=>{a&&this.gestoresUnidadeExecutora.push(a)}),this.gestoresUnidadeExecutora}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["plano-trabalho-form"]],viewQuery:function(a,t){if(a&1&&(y(M,5),y(ii,5),y(oi,5),y(ni,5),y(ri,5),y(li,5),y(si,5),y(di,5),y(ci,5),y(mi,5),y(pi,5),y(ui,5)),a&2){let l;T(l=E())&&(t.editableForm=l.first),T(l=E())&&(t.gridAtividades=l.first),T(l=E())&&(t.gridDocumentos=l.first),T(l=E())&&(t.tabs=l.first),T(l=E())&&(t.usuario=l.first),T(l=E())&&(t.programa=l.first),T(l=E())&&(t.unidade=l.first),T(l=E())&&(t.tipoModalidade=l.first),T(l=E())&&(t.planoEntrega=l.first),T(l=E())&&(t.atividade=l.first),T(l=E())&&(t.entrega=l.first),T(l=E())&&(t.documentos=l.first)}},features:[U],decls:24,vars:36,consts:[["tabs",""],["usuario",""],["unidade",""],["programa",""],["tipoModalidade",""],["documentos",""],["initialFocus","plano_entrega_id",3,"submit","cancel","form","disabled","noButtons"],["display","","right","",3,"hidden","title","select"],["key","DADOS","label","Dados"],[1,"row"],[1,"col-md-12"],["required","","controlName","usuario_id",3,"select","size","disabled","dao","join"],["required","","controlName","unidade_id",3,"select","size","disabled","dao"],["icon","bi bi-file-bar-graph","required","","controlName","programa_id",3,"select","size","label","disabled","join","dao","metadata"],["label","In\xEDcio","icon","bi bi-calendar-date","controlName","data_inicio","required","",3,"change","size","control","labelInfo"],["label","Final","icon","bi bi-calendar-date","controlName","data_fim","required","",3,"change","size","control","labelInfo"],["controlName","tipo_modalidade_id","required","",3,"size","dao"],[4,"ngIf"],[3,"title"],["type","warning",3,"message",4,"ngIf"],["key","MENSAGENS",3,"label",4,"ngIf"],["key","TERMO",3,"label",4,"ngIf"],["label","Carga Hor\xE1ria","icon","bi bi-hourglass-split","controlName","carga_horaria","labelInfo","Carga hor\xE1ria do usu\xE1rio (M\xE1x.: di\xE1ria 24 horas; semana 24*5=240 horas; mensal 24*20=480 horas)","required","",3,"change","size","unit","control","unitChange"],["onlyHours","","disabled","","label","Horas Totais","icon","bi bi-clock","controlName","tempo_total","labelInfo","Horas \xFAteis de trabalho no per\xEDodo de vig\xEAncia considerando a carga hor\xE1ria, feriados e fins de semana",3,"size","control"],["onlyHours","","disabled","","label","Horas Parciais","icon","bi bi-clock","controlName","tempo_proporcional","labelInfo","Total de horas menos os afastamentos.",3,"size","control"],["title","C\xE1lculos das horas totais","collapse","",4,"ngIf"],["title","C\xE1lculos das horas parciais","collapse","",4,"ngIf"],["title","C\xE1lculos das horas totais","collapse",""],[3,"efemerides","partial"],["title","C\xE1lculos das horas parciais","collapse",""],[3,"efemerides"],["type","warning",3,"message"],["noPersist","",3,"disabled","entity"],["key","MENSAGENS",3,"label"],["controlName","editar_texto_complementar_unidade","scale","small","labelPosition","right",3,"disabled","size","label"],["controlName","unidade_texto_complementar",3,"disabled","dataset"],["title","Texto complementar do usuario"],["controlName","editar_texto_complementar_usuario","scale","small","labelPosition","right",3,"disabled","size","label"],["controlName","usuario_texto_complementar",3,"disabled","dataset"],["key","TERMO",3,"label"],["clss","row"],["noPersist","","especie","TCR",3,"entity","disabled","cdRef","needSign","extraTags","editingId","datasource","template"]],template:function(a,t){if(a&1){let l=O();c(0,"editable-form",6),w("submit",function(){return I(l),S(t.onSaveData())})("cancel",function(){return I(l),S(t.onCancel())}),c(1,"tabs",7,0)(3,"tab",8)(4,"div",9)(5,"div",10)(6,"div",9)(7,"input-search",11,1),w("select",function(g){return I(l),S(t.onUsuarioSelect(g))}),d(),c(9,"input-search",12,2),w("select",function(g){return I(l),S(t.onUnidadeSelect(g))}),d(),c(11,"input-search",13,3),w("select",function(g){return I(l),S(t.onProgramaSelect(g))}),d()(),c(13,"div",9)(14,"input-datetime",14),w("change",function(g){return I(l),S(t.onDataInicioChange(g))}),d(),c(15,"input-datetime",15),w("change",function(g){return I(l),S(t.onDataFimChange(g))}),d(),m(16,"input-search",16,4),d(),_(18,vi,7,10,"ng-container",17),d()(),c(19,"separator",18),_(20,Ci,1,1,"top-alert",19)(21,yi,2,2,"div",17),d()(),_(22,Ti,7,12,"tab",20)(23,Ei,4,9,"tab",21),d()()}if(a&2){let l=h(17);n("form",t.form)("disabled",t.formDisabled)("noButtons",t.isTermos?"true":void 0),s(),n("hidden",t.isTermos?"true":void 0)("title",t.isModal?"":t.title)("select",t.onTabSelect.bind(t)),s(6),n("size",4)("disabled",t.action=="new"?void 0:"true")("dao",t.usuarioDao)("join",N(33,_i)),s(2),n("size",4)("disabled",t.action=="new"?void 0:"true")("dao",t.unidadeDao),s(2),n("size",4)("label",t.lex.translate("Programa de gest\xE3o"))("disabled",t.action=="new"?void 0:"true")("join",t.joinPrograma)("dao",t.programaDao)("metadata",t.programaMetadata),s(3),n("size",3)("control",t.form.controls.data_inicio)("labelInfo","In\xEDcio da Vig\xEAncia do "+t.lex.translate("Plano de trabalho")),s(),n("size",3)("control",t.form.controls.data_fim)("labelInfo","Final da Vig\xEAncia do "+t.lex.translate("Plano de trabalho")),s(),n("size",6)("dao",t.tipoModalidadeDao),s(2),n("ngIf",l.selectedEntity==null?null:l.selectedEntity.plano_trabalho_calcula_horas),s(),n("title",t.lex.translate("Entregas")+t.lex.translate(" do plano de trabalho")),s(),n("ngIf",!(t.form.controls.programa_id.value!=null&&t.form.controls.programa_id.value.length)||!(t.form.controls.unidade_id.value!=null&&t.form.controls.unidade_id.value.length)),s(),n("ngIf",(t.form.controls.programa_id.value==null?null:t.form.controls.programa_id.value.length)&&(t.form.controls.unidade_id.value==null?null:t.form.controls.unidade_id.value.length)),s(),n("ngIf",t.checkFilled(N(34,hi))),s(),n("ngIf",t.checkFilled(N(35,fi)))}},dependencies:[z,M,ee,L,le,kt,se,ve,Q,Qt,Ne,Lt,Nt,Jt,ye]});let o=r;return o})();var Te=class extends bt{constructor(r){super(),this.data_inicio=new Date,this.data_fim=new Date,this.status="INCLUIDO",this.avaliacoes=[],this.status_historico=[],this.plano_trabalho_id="",this.avaliacao_id=null,this.initialization(r)}};var sa=(()=>{let r=class r extends yt{constructor(e){super("Comparecimento",e),this.injector=e,this.inputSearchConfig.searchFields=["data_comparecimento"]}};r.\u0275fac=function(a){return new(a||r)(st(R))},r.\u0275prov=lt({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();var Di=["gridEntregas"],Ii=["gridAtividades"],Si=["etiqueta"],Ai=["tipoAtividade"],wi=["listTarefas"],Pi=()=>({abrirEmEdicao:!0});function Ri(o,r){if(o&1&&(c(0,"span",47),m(1,"i",48),v(2),d()),o&2){let i=u().row;s(2),P(" ",i.atividades==null?null:i.atividades.length,"")}}function Oi(o,r){if(o&1&&_(0,Ri,3,1,"span",46),o&2){let i=r.row;n("ngIf",i.atividades==null?null:i.atividades.length)}}function Fi(o,r){if(o&1&&(c(0,"span",47),m(1,"i",48),v(2),d()),o&2){let i=u().row;s(2),P(" ",i.tarefas==null?null:i.tarefas.length,"")}}function Vi(o,r){if(o&1&&_(0,Fi,3,1,"span",46),o&2){let i=r.row;n("ngIf",i.tarefas==null?null:i.tarefas.length)}}function Ui(o,r){if(o&1&&m(0,"atividade-list-tarefa",55,24),o&2){let i=r.row;n("atividade",i)("consolidacao",!1)}}function ki(o,r){if(o&1&&(c(0,"span",56),m(1,"badge",57),d(),c(2,"span",58),v(3),d(),m(4,"reaction",59)),o&2){let i=r.row,e=u(2);s(),n("label",i.numero)("data",i.numero)("click",e.atividadeService.onIdClick.bind(e)),s(2),A(i.descricao),s(),n("entity",i)}}function Li(o,r){if(o&1&&m(0,"input-textarea",60),o&2){let i=u(2);n("size",12)("rows",2)("control",i.formAtividade.controls.descricao)}}function qi(o,r){if(o&1&&m(0,"badge",63),o&2){let i=r.$implicit;n("badge",i)}}function Ni(o,r){if(o&1&&(c(0,"div",61),_(1,qi,1,1,"badge",62),d()),o&2){let i=r.row,e=u(2);s(),n("ngForOf",e.tempoAtividade(i))}}function zi(o,r){if(o&1&&(c(0,"separator",64),m(1,"input-datetime",65)(2,"input-datetime",66),d()),o&2){let i=u(2);n("collapsed",!0),s(),n("control",i.formAtividade.controls.data_inicio),s(),n("control",i.formAtividade.controls.data_entrega)}}function Bi(o,r){if(o&1&&m(0,"badge",71),o&2){let i=r.$implicit;n("lookup",i)}}function Mi(o,r){o&1&&m(0,"separator",72)}function Qi(o,r){o&1&&m(0,"i",76)}function Hi(o,r){if(o&1&&(c(0,"tr")(1,"td"),_(2,Qi,1,0,"i",74),d(),c(3,"td",75),v(4),d()()),o&2){let i=r.$implicit;s(2),n("ngIf",i.checked),s(2),A(i.texto)}}function Gi(o,r){if(o&1&&(c(0,"table"),_(1,Hi,5,2,"tr",73),d()),o&2){let i=u().row;s(),n("ngForOf",i.checklist)}}function ji(o,r){if(o&1&&(m(0,"progress-bar",67),_(1,Bi,1,1,"badge",68)(2,Mi,1,0,"separator",69)(3,Gi,2,1,"table",70)),o&2){let i=r.row;n("value",i.progresso),s(),n("ngForOf",i.etiquetas),s(),n("ngIf",i.checklist==null?null:i.checklist.length),s(),n("ngIf",i.checklist==null?null:i.checklist.length)}}function Wi(o,r){o&1&&m(0,"separator",72)}function Ji(o,r){if(o&1&&(c(0,"tr")(1,"td"),m(2,"input-switch",80),d(),c(3,"td",75),v(4),d()()),o&2){let i=r.$implicit,e=r.index,a=u(4);s(2),n("size",12)("source",a.checklist)("path",e+".checked"),s(2),A(i.texto)}}function $i(o,r){if(o&1&&(c(0,"table"),_(1,Ji,5,4,"tr",73),d()),o&2){let i=u(3);s(),n("ngForOf",i.checklist)}}function Xi(o,r){if(o&1){let i=O();v(0),m(1,"input-number",77),c(2,"input-multiselect",78)(3,"input-select",79,25),w("details",function(){I(i);let a=u(2);return S(a.onEtiquetaConfigClick())}),d()(),_(5,Wi,1,0,"separator",69)(6,$i,2,1,"table",70)}if(o&2){let i=r.row,e=u(2);P(" ",i._status," "),s(),n("size",12)("decimals",2)("control",e.formEdit.controls.progresso),s(),n("size",12)("control",e.formEdit.controls.etiquetas)("addItemHandle",e.addItemHandleEtiquetas.bind(e)),s(),n("size",12)("control",e.formEdit.controls.etiqueta)("items",e.etiquetas),s(2),n("ngIf",i.checklist==null?null:i.checklist.length),s(),n("ngIf",i.checklist==null?null:i.checklist.length)}}function Zi(o,r){if(o&1&&m(0,"badge",85),o&2){let i=r.$implicit;n("data",i)("color",i.color)("icon",i.icon)("label",i.label)}}function Ki(o,r){if(o&1&&m(0,"comentarios-widget",86),o&2){let i=u().row;u();let e=h(1);n("entity",i)("selectable",!1)("grid",e)}}function Yi(o,r){if(o&1&&(m(0,"documentos-badge",81),c(1,"span",82),_(2,Zi,1,4,"badge",83),d(),_(3,Ki,1,3,"comentarios-widget",84)),o&2){let i=r.row;u();let e=h(1),a=u();n("documento",i.documento_requisicao),s(2),n("ngForOf",a.atividadeService.getStatus(i,a.entity)),s(),n("ngIf",!e.editing)}}function eo(o,r){if(o&1&&(c(0,"grid",49,14)(2,"columns")(3,"column",50),_(4,Vi,1,1,"ng-template",null,15,f)(6,Ui,2,2,"ng-template",null,16,f),d(),c(8,"column",51),_(9,ki,5,5,"ng-template",null,17,f)(11,Li,1,3,"ng-template",null,18,f),d(),c(13,"column",52),_(14,Ni,2,1,"ng-template",null,19,f)(16,zi,3,3,"ng-template",null,20,f),d(),c(18,"column",53),_(19,ji,4,4,"ng-template",null,21,f)(21,Xi,7,12,"ng-template",null,22,f),d(),c(23,"column",52),_(24,Yi,4,3,"ng-template",null,23,f),d(),m(26,"column",54),d()()),o&2){let i=r.row,e=h(5),a=h(7),t=h(10),l=h(12),p=h(15),g=h(17),D=h(20),C=h(22),q=h(25),x=u();n("items",i.atividades)("minHeight",0)("form",x.formAtividade)("hasAdd",!x.disabled)("hasDelete",!1)("hasEdit",!1)("add",x.addAtividade.bind(x,i.entrega))("load",x.loadAtividade.bind(x))("remove",x.removeAtividade.bind(x,i.atividades))("save",x.saveAtividade.bind(x)),s(3),n("width",50)("align","center")("hint","Tarefas da "+x.lex.translate("atividade"))("template",e)("expandTemplate",a),s(5),n("title","#ID/Trabalho executado")("width",400)("template",t)("editTemplate",l)("columnEditTemplate",l)("edit",x.onColumnAtividadeDescricaoEdit.bind(x))("save",x.onColumnAtividadeDescricaoSave.bind(x))("metadata",N(42,Pi)),s(5),n("title","In\xEDcio e Conclus\xE3o")("width",250)("template",p)("editTemplate",g),s(5),n("title",`Progresso
Etiquetas/Checklist`)("width",200)("template",D)("editTemplate",D)("columnEditTemplate",C)("edit",x.onColumnProgressoEtiquetasChecklistEdit.bind(x))("save",x.onColumnProgressoEtiquetasChecklistSave.bind(x))("canEdit",x.podeEditar.bind(x)),s(5),n("title",`n\xBA Processo/Status
Coment\xE1rios`)("width",300)("template",q)("editTemplate",q),s(3),n("metadata",x.atividadeOptionsMetadata)("dynamicOptions",x.atividadeService.dynamicOptions.bind(x))("dynamicButtons",x.atividadeService.dynamicButtons.bind(x))}}function to(o,r){if(o&1&&m(0,"badge",87),o&2){let i=r.row;n("label",i.badge.titulo)("color",i.badge.cor)}}function ao(o,r){if(o&1&&(v(0),m(1,"br"),c(2,"small"),v(3),d(),m(4,"reaction",88)),o&2){let i=r.row;P(" ",i.badge.descricao||i.entrega.descricao,""),s(3),A(i.entrega.descricao),s(),n("entity",i.entrega)}}function io(o,r){if(o&1&&m(0,"badge",89),o&2){let i=r.row;n("label",i.entrega.forca_trabalho+"%")}}function oo(o,r){if(o&1&&m(0,"badge",90)(1,"br")(2,"badge",91),o&2){let i=r.row;n("textValue",i.meta),s(2),n("textValue",i.metaRealizado)}}function no(o,r){if(o&1&&m(0,"progress-bar",67),o&2){let i=r.row;n("value",i.progresso_realizado)}}function ro(o,r){if(o&1&&(m(0,"badge",92),v(1)),o&2){let i=r.row;n("color",i.tipo_motivo_afastamento.cor)("icon",i.tipo_motivo_afastamento.icone)("label",i.tipo_motivo_afastamento.nome),s(),P(" ",i.observacao," ")}}function lo(o,r){if(o&1&&m(0,"badge",93),o&2){let i=r.row,e=u();n("icon",e.entityService.getIcon("Unidade"))("label",i.unidade.sigla)("textValue",i.unidade.nome)}}function so(o,r){if(o&1&&m(0,"input-search",94,26),o&2){let i=u();n("size",6)("dao",i.unidadeDao)}}var Ze=(()=>{let r=class r extends Y{set noPersist(e){super.noPersist=e}get noPersist(){return super.noPersist}set control(e){super.control=e}get control(){return super.control}set entity(e){super.entity=e,this.bindEntity()}get entity(){return super.entity}set disabled(e){(this._disabled!=e||this.atividadeOptionsMetadata.disabled!==e)&&(this._disabled=e,this.atividadeOptionsMetadata.disabled=e,this.cdRef.detectChanges())}get disabled(){return this._disabled}constructor(e){super(e),this.injector=e,this.joinAtividade=["demandante","usuario","tipo_atividade","comentarios.usuario:id,nome,apelido","reacoes.usuario:id,nome,apelido"],this.itemsEntregas=[],this.etiquetas=[],this.etiquetasAscendentes=[],this.itemsOcorrencias=[],this.itemsComparecimentos=[],this.itemsAfastamentos=[],this._disabled=!0,this.validateAtividade=(a,t)=>{let l=null;return["descricao"].indexOf(t)>=0&&!a.value?.length?l="Obrigat\xF3rio":["data_inicio","data_entrega"].includes(t)&&!this.util.isDataValid(a.value)?l="Inv\xE1lido":t=="data_inicio"&&a.value.getTime()<this.formAtividade?.controls.data_distribuicao.value.getTime()||t=="data_entrega"&&a.value.getTime()<this.formAtividade?.controls.data_distribuicao.value.getTime()?l="Menor que distribui\xE7\xE3o":t=="data_entrega"&&a.value.getTime()<this.formAtividade?.controls.data_inicio.value.getTime()&&(l="Menor que in\xEDcio"),l},this.validateComparecimento=(a,t)=>{let l=null;return["detalhamento","unidade_id"].indexOf(t)>=0&&!a.value?.length?l="Obrigat\xF3rio":t=="data_comparecimento"&&this.entity&&!this.util.between(a.value,{start:this.entity.data_inicio,end:this.entity.data_fim})&&(l="Inv\xE1lido"),l},this.cdRef=e.get(Ae),this.dao=e.get(he),this.unidadeDao=e.get($),this.comparecimentoDao=e.get(sa),this.atividadeDao=e.get(At),this.atividadeService=e.get(Kt),this.calendar=e.get(we),this.ocorrenciaDao=e.get(Pt),this.tipoAtividadeDao=e.get(xt),this.planoTrabalhoService=e.get(te),this.planoEntregaService=e.get(Xt),this.pEEDao=e.get(Oe),this.formAtividade=this.fh.FormBuilder({descricao:{default:""},etiquetas:{default:[]},checklist:{default:[]},comentarios:{default:[]},esforco:{default:0},tempo_planejado:{default:0},data_distribuicao:{default:new Date},data_estipulada_entrega:{default:new Date},data_inicio:{default:new Date},data_entrega:{default:new Date}},this.cdRef,this.validateAtividade),this.formComparecimento=this.fh.FormBuilder({data_comparecimento:{default:new Date},unidade_id:{default:""},detalhamento:{default:""}},this.cdRef,this.validateComparecimento),this.formEdit=this.fh.FormBuilder({descricao:{default:""},comentarios:{default:[]},progresso:{default:0},etiquetas:{default:[]},etiqueta:{default:null}}),this.atividadeOptionsMetadata={refreshId:this.atividadeRefreshId.bind(this),removeId:this.atividadeRemoveId.bind(this),refresh:this.refresh.bind(this)}}refresh(){this.loadData(this.entity,this.form)}bindEntity(){this.entity&&(this.entity._metadata=this.entity._metadata||{},this.entity._metadata.planoTrabalhoConsolidacaoFormComponent=this)}atividadeRefreshId(e,a){this.itemsEntregas.forEach(t=>{let l=t.atividades.findIndex(p=>p.id==e);l>=0&&(a?t.atividades[l]=a:this.atividadeDao.getById(e,this.joinAtividade).then(p=>{p&&(t.atividades[l]=p)}))}),this.cdRef.detectChanges()}atividadeRemoveId(e){this.itemsEntregas.forEach(a=>{let t=a.atividades.findIndex(l=>l.id==e);t>=0&&a.atividades.splice(t,1)}),this.cdRef.detectChanges()}ngAfterViewInit(){super.ngAfterViewInit(),b(this,null,function*(){yield this.loadData(this.entity,this.form)})}loadConsolidacao(e){this.itemsEntregas=e.entregas.map(a=>(a.plano_entrega_entrega&&(a.plano_entrega_entrega.plano_entrega=e.planosEntregas.find(l=>l.id==a.plano_entrega_entrega?.plano_entrega_id)),{id:a.id,entrega:a,atividades:e.atividades.filter(l=>l.plano_trabalho_entrega_id==a.id),badge:this.planoTrabalhoService.tipoEntrega(a,e.planoTrabalho),meta:a.plano_entrega_entrega?this.planoEntregaService.getValorMeta(a.plano_entrega_entrega):"",metaRealizado:a.plano_entrega_entrega?this.planoEntregaService.getValorRealizado(a.plano_entrega_entrega):"",progresso_realizado:a.plano_entrega_entrega?a.plano_entrega_entrega.progresso_realizado:0,objetivos:a.plano_entrega_entrega?a.plano_entrega_entrega.objetivos:[],processos:a.plano_entrega_entrega?a.plano_entrega_entrega.processos:[]})),this.programa=e.programa,this.planoTrabalho=e.planoTrabalho,this.itemsOcorrencias=e.ocorrencias,this.itemsComparecimentos=e.comparecimentos,this.itemsAfastamentos=e.afastamentos,this.unidade=e.planoTrabalho.unidade||this.entity.plano_trabalho?.unidade,this.cdRef.detectChanges()}loadData(e,a){return b(this,null,function*(){this.gridEntregas.loading=!0,this.cdRef.detectChanges();try{let t=yield this.dao.dadosConsolidacao(e.id);this.loadConsolidacao(t)}finally{this.gridEntregas.loading=!1,this.cdRef.detectChanges()}})}addAtividade(e){return b(this,null,function*(){let a=e.plano_trabalho||this.entity.plano_trabalho,t=this.calendar.calculaDataTempoUnidade(this.entity.data_inicio,this.entity.data_fim,a.carga_horaria,this.unidade,"ENTREGA"),l=this.calendar.horasUteis(this.entity.data_inicio,this.entity.data_fim,a.carga_horaria,this.unidade,"DISTRIBUICAO"),p=this.util.maxDate(this.util.setTime(this.entity.data_inicio,0,0,0),a.data_inicio),g=this.util.minDate(this.util.setTime(this.entity.data_fim,23,59,59),a.data_fim),D=this.dao.generateUuid();return new It({id:D,plano_trabalho:a,plano_trabalho_entrega:e,plano_trabalho_consolidacao:this.entity,demandante:this.auth.usuario,usuario:this.auth.usuario,unidade:this.unidade,data_distribuicao:p,carga_horaria:a.carga_horaria,data_estipulada_entrega:g,data_inicio:p,data_entrega:g,tempo_planejado:l,tempo_despendido:t?.tempoUtil||0,status:"CONCLUIDO",progresso:100,plano_trabalho_id:this.entity.plano_trabalho_id,plano_trabalho_entrega_id:e.id,plano_trabalho_consolidacao_id:this.entity.id,demandante_id:this.auth.usuario.id,usuario_id:this.auth.usuario.id,unidade_id:this.unidade.id,metadados:{atrasado:!1,tempo_despendido:0,tempo_atraso:0,pausado:!1,iniciado:!0,concluido:!0,avaliado:!1,arquivado:!1,produtividade:0,extra:void 0,_status:[]},_status:"temporario"})})}loadAtividade(e,a){return b(this,null,function*(){this.formAtividade.patchValue(a),this.cdRef.detectChanges()})}removeAtividade(e,a){return b(this,null,function*(){if(yield this.dialog.confirm("Exclui ?","Deseja realmente excluir o item ?"))try{let l=a;return yield this.atividadeDao?.delete(l),e.splice(e.findIndex(p=>p.id==l.id),1),!0}catch{return!1}else return!1})}saveAtividade(e,a){return b(this,null,function*(){let t;if(this.gridAtividades.error="",this.formAtividade.markAllAsTouched(),this.formAtividade.valid){a.id=a.id=="NEW"?this.dao.generateUuid():a.id,this.util.fillForm(a,this.formAtividade.value),this.submitting=!0;try{t=yield this.atividadeDao?.save(a,this.joinAtividade,["etiquetas","checklist","comentarios","pausas","tarefas"]),this.atividadeRefreshId(a.id,t)}catch(l){t=!1,this.gridAtividades.error=l.message||l}finally{this.submitting=!1}}return t})}onDataDistribuicaoChange(e){this.formAtividade.controls.data_inicio.setValue(this.formAtividade.controls.data_distribuicao.value)}onDataEstipuladaEntregaChange(e){this.formAtividade.controls.data_entrega.setValue(this.formAtividade.controls.data_estipulada_entrega.value)}atividadeDynamicButtons(e){let a=[];return a.push(Object.assign({},this.gridEntregas.BUTTON_EDIT,{})),a.push(Object.assign({},this.gridEntregas.BUTTON_DELETE,{})),a}onColumnProgressoEtiquetasChecklistEdit(e){return b(this,null,function*(){if(!this.etiquetasAscendentes.filter(a=>a.data==e.plano_trabalho.unidade.id).length){let a=yield this.carregaEtiquetasUnidadesAscendentes(e.plano_trabalho.unidade);this.etiquetasAscendentes.push(...a)}this.formEdit.controls.progresso.setValue(e.progresso),this.formEdit.controls.etiquetas.setValue(e.etiquetas),this.formEdit.controls.etiqueta.setValue(null),this.etiquetas=this.util.merge(e.tipo_atividade?.etiquetas,e.plano_trabalho.unidade?.etiquetas,(a,t)=>a.key==t.key),this.etiquetas=this.util.merge(this.etiquetas,this.auth.usuario.config?.etiquetas,(a,t)=>a.key==t.key),this.etiquetas=this.util.merge(this.etiquetas,this.etiquetasAscendentes.filter(a=>a.data==e.plano_trabalho.unidade.id),(a,t)=>a.key==t.key),this.checklist=this.util.clone(e.checklist)})}carregaEtiquetasUnidadesAscendentes(e){return b(this,null,function*(){let a=[];if(e=e||this.auth.unidade,e.path){let t=e.path.split("/");(yield this.unidadeDao.query({where:[["id","in",t]]}).asPromise()).forEach(p=>{a=this.util.merge(a,p.etiquetas,(g,D)=>g.key==D.key)}),a.forEach(p=>p.data=e.id)}return a})}onColumnProgressoEtiquetasChecklistSave(e){return b(this,null,function*(){console.log(e);try{let a=yield this.atividadeDao.update(e.id,{progresso:this.formEdit.controls.progresso.value,etiquetas:this.formEdit.controls.etiquetas.value,checklist:this.checklist});return e.progresso=this.formEdit.controls.progresso.value,e.checklist=this.checklist,!!a}catch{return!1}})}onEtiquetaConfigClick(){this.go.navigate({route:["configuracoes","preferencia","usuario",this.auth.usuario.id],params:{etiquetas:!0}},{modal:!0,modalClose:e=>{this.etiquetas=this.util.merge(this.etiquetas,this.auth.usuario.config?.etiquetas,(a,t)=>a.key==t.key),this.cdRef.detectChanges()}})}addItemHandleEtiquetas(){let e;if(this.etiqueta&&this.etiqueta.selectedItem){let a=this.etiqueta.selectedItem,t=a.key?.length?a.key:this.util.textHash(a.value);this.util.validateLookupItem(this.formEdit.controls.etiquetas.value,t)&&(e={key:t,value:a.value,color:a.color,icon:a.icon},this.formEdit.controls.etiqueta.setValue(null))}return e}podeEditar(e){return!e._status}loadTipoAtividade(e){e?(this.etiquetas=this.atividadeService.buildEtiquetas(this.unidade,e),this.atividadeService.buildChecklist(e,this.formAtividade.controls.checklist),this.formAtividade.controls.esforco.setValue(e?.esforco||0)):(this.etiquetas=[],this.formAtividade.controls.esforco.setValue(0)),this.cdRef.detectChanges()}onTipoAtividadeSelect(e){let a=e.entity;this.loadTipoAtividade(a),this.atividadeService.comentarioAtividade(a,this.formAtividade.controls.comentarios),this.cdRef.detectChanges()}onColumnAtividadeDescricaoEdit(e){return b(this,null,function*(){this.formAtividade.controls.descricao.setValue(e.descricao),this.formAtividade.controls.comentarios.setValue(e.comentarios)})}onColumnAtividadeDescricaoSave(e){return b(this,null,function*(){try{this.atividadeService.comentarioAtividade(this.tipoAtividade?.selectedEntity,this.formAtividade.controls.comentarios);let a=yield this.atividadeDao.update(e.id,{descricao:this.formAtividade.controls.descricao.value,comentarios:(this.formAtividade.controls.comentarios.value||[]).filter(t=>["ADD","EDIT","DELETE"].includes(t._status||""))});return e.descricao=this.formAtividade.controls.descricao.value,e.tipo_atividade=this.tipoAtividade?.selectedEntity||null,e.comentarios=this.formAtividade.controls.comentarios.value,!!a}catch{return!1}})}tempoAtividade(e){let a=[{color:"light",hint:"In\xEDcio",icon:"bi bi-file-earmark-play",label:this.dao.getDateTimeFormatted(e.data_inicio)}],t=this.atividadeService.temposAtividade(e);return t=t.filter(l=>l.icon!="bi bi-file-earmark-plus"&&l.icon!="bi bi-calendar-check"),a.push(...t),a}dynamicButtons(e){let a=[];return a.push({label:"Detalhes",icon:"bi bi-eye",color:"btn-outline-success",onClick:this.showDetalhes.bind(this)}),a}showDetalhes(e){return b(this,null,function*(){let a=yield this.pEEDao.getById(e.entrega.plano_entrega_entrega.id,["entrega","objetivos.objetivo"]);this.go.navigate({route:["gestao","plano-entrega","entrega",e.entrega.plano_entrega_entrega.id,"detalhes"]},{metadata:{plano_entrega:e.entrega.plano_entrega_entrega.plano_entrega,planejamento_id:e.entrega.plano_entrega_entrega.plano_entrega.planejamento_id,cadeia_valor_id:e.entrega.plano_entrega_entrega.plano_entrega.cadeia_valor_id,unidade_id:e.entrega.plano_entrega_entrega.plano_entrega.unidade_id,entrega:a}})})}addOcorrencia(){return b(this,null,function*(){this.go.navigate({route:["gestao","ocorrencia","new"]},{metadata:{consolidacao:this.entity,planoTrabalho:this.planoTrabalho},modalClose:e=>{e&&this.refresh()}})})}editOcorrencia(e){return b(this,null,function*(){this.go.navigate({route:["gestao","ocorrencia",e.id,"edit"]},{modalClose:a=>{a&&this.refresh()}})})}removeOcorrencia(e){return b(this,null,function*(){if(yield this.dialog.confirm("Exclui ?","Deseja realmente excluir o item ?")){this.submitting=!0;try{let a=e;yield this.ocorrenciaDao?.delete(a),this.itemsOcorrencias.splice(this.itemsOcorrencias.findIndex(t=>t.id==a.id),1)}finally{this.submitting=!1}}})}ocorrenciaDynamicButtons(e){let a=[];return!this.disabled&&this.auth.hasPermissionTo("MOD_OCOR_EDT")&&a.push(Object.assign({},this.OPTION_ALTERAR,{onClick:this.editOcorrencia.bind(this)})),!this.disabled&&this.auth.hasPermissionTo("MOD_OCOR_EXCL")&&a.push(Object.assign({},this.OPTION_EXCLUIR,{onClick:this.removeOcorrencia.bind(this)})),a}addComparecimento(){return b(this,null,function*(){return new wt({unidade_id:this.unidade?.id,unidade:this.unidade,plano_trabalho_consolidacao_id:this.entity.id})})}loadComparecimento(e,a){return b(this,null,function*(){this.formComparecimento.patchValue({data_comparecimento:a.data_comparecimento,unidade_id:a.unidade_id,detalhamento:a.detalhamento}),this.cdRef.detectChanges()})}removeComparecimento(e){return b(this,null,function*(){if(yield this.dialog.confirm("Exclui ?","Deseja realmente excluir o item ?"))try{let t=e;return yield this.comparecimentoDao?.delete(t),this.itemsComparecimentos.splice(this.itemsComparecimentos.findIndex(l=>l.id==t.id),1),!0}catch{return!1}else return!1})}saveComparecimento(e,a){return b(this,null,function*(){let t;if(this.formComparecimento.markAllAsTouched(),this.formComparecimento.valid){a.id=a.id=="NEW"?this.dao.generateUuid():a.id,a.data_comparecimento=e.controls.data_comparecimento.value,a.detalhamento=e.controls.detalhamento.value,a.plano_trabalho_consolidacao_id=this.entity.id,a.unidade_id=e.controls.unidade_id.value,this.submitting=!0;try{t=yield this.comparecimentoDao?.save(a)}finally{this.submitting=!1}}return t})}comparecimentoDynamicButtons(e){return[]}addAfastamento(){return b(this,null,function*(){this.go.navigate({route:["gestao","afastamento","new"]},{metadata:{consolidacao:this.entity},filterSnapshot:void 0,querySnapshot:void 0,modalClose:e=>{e&&this.refresh()}})})}afastamentoDynamicButtons(e){let a=[];return a.push(Object.assign({},this.OPTION_INFORMACOES,{onClick:t=>this.go.navigate({route:["cadastros","afastamento",t.id,"consult"]})})),a}showPlanejamento(e){return b(this,null,function*(){this.go.navigate({route:["gestao","planejamento",e,"consult"]},{modal:!0})})}showCadeiaValor(e){return b(this,null,function*(){this.go.navigate({route:["gestao","cadeia-valor",e,"consult"]},{modal:!0})})}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["plano-trabalho-consolidacao-form"]],viewQuery:function(a,t){if(a&1&&(y(M,5),y(Di,5),y(Ii,5),y(Si,5),y(Ai,5),y(wi,5)),a&2){let l;T(l=E())&&(t.editableForm=l.first),T(l=E())&&(t.gridEntregas=l.first),T(l=E())&&(t.gridAtividades=l.first),T(l=E())&&(t.etiqueta=l.first),T(l=E())&&(t.tipoAtividade=l.first),T(l=E())&&(t.listTarefas=l.first)}},inputs:{cdRef:"cdRef",planoTrabalho:"planoTrabalho",noPersist:"noPersist",control:"control",entity:"entity",disabled:"disabled"},features:[U],decls:55,vars:66,consts:[["gridEntregas",""],["columnConsolidacao",""],["columnExpandedConsolidacao",""],["columnOrigem",""],["columnEntrega",""],["columnForcaTrabalho",""],["columnMetaRealizado",""],["columnProgresso",""],["gridOcorrencia",""],["gridAfastamento",""],["columnMotivoObservacao",""],["gridComparecimento",""],["columnUnidade",""],["editUnidade",""],["gridAtividades",""],["columnTarefas",""],["columnExpandedTarefas",""],["columnAtividadeDescricao",""],["editAtividadeDescricao",""],["columnTempos",""],["editTempos",""],["columnProgressoEtiquetasChecklist",""],["columnProgressoEtiquetasChecklistEdit",""],["columnNumero",""],["listTarefas",""],["etiqueta",""],["unidade",""],["collapse","",3,"collapsed","title","icon"],[3,"items","minHeight","hasEdit"],["type","expand",3,"width","icon","align","hint","template","expandTemplate"],["title","Origem",3,"template","width"],["title","Entrega",3,"template"],["title","% CHD Planejado",3,"template","width","titleHint"],[3,"title","template","width"],["title","Progresso",3,"template","width"],["type","options",3,"dynamicButtons"],["editable","",3,"items","minHeight","hasDelete","hasEdit","hasAdd","add"],["title","In\xEDcio","type","datetime","field","data_inicio",3,"width"],["title","Fim","type","datetime","field","data_fim",3,"width"],["title","Descri\xE7\xE3o","type","textarea","field","descricao"],["editable","",3,"items","minHeight","hasEdit","hasDelete","hasAdd","add"],["title","Motivo/Observa\xE7\xE3o",3,"template"],["editable","",3,"items","minHeight","form","hasDelete","hasAdd","hasEdit","add","load","remove","save"],["title","Data","type","date","field","data_comparecimento",3,"width"],["title","Unidade",3,"template","editTemplate"],["title","Detalhamento","type","text","field","detalhamento"],["class","badge rounded-pill bg-light text-dark",4,"ngIf"],[1,"badge","rounded-pill","bg-light","text-dark"],[1,"bi","bi-boxes"],["editable","",3,"items","minHeight","form","hasAdd","hasDelete","hasEdit","add","load","remove","save"],["type","expand","icon","bi bi-boxes",3,"width","align","hint","template","expandTemplate"],[3,"title","width","template","editTemplate","columnEditTemplate","edit","save","metadata"],[3,"title","width","template","editTemplate"],[3,"title","width","template","editTemplate","columnEditTemplate","edit","save","canEdit"],["type","options",3,"metadata","dynamicOptions","dynamicButtons"],["persist","",3,"atividade","consolidacao"],[1,"text-nowrap","d-block"],["icon","bi bi-hash","color","light",3,"label","data","click"],[1,"micro-text","fw-ligh","atividade-descricao"],["origem","ATIVIDADE",3,"entity"],["label","Descri\xE7\xE3o","controlName","descricao","required","",3,"size","rows","control"],[1,"one-per-line"],[3,"badge",4,"ngFor","ngForOf"],[3,"badge"],["title","In\xEDcio e Conclus\xE3o","collapse","",3,"collapsed"],["icon","bi bi-play-circle","label","In\xEDcio","controlName","data_inicio","labelInfo","Data de inicializa\xE7\xE3o da atividade",3,"control"],["icon","bi bi-check-circle","label","Conclus\xE3o","controlName","data_entrega","labelInfo","Data da conclus\xE3o da atividade",3,"control"],["color","success",3,"value"],[3,"lookup",4,"ngFor","ngForOf"],["small","","title","Checklist",4,"ngIf"],[4,"ngIf"],[3,"lookup"],["small","","title","Checklist"],[4,"ngFor","ngForOf"],["class","bi bi-check-circle",4,"ngIf"],[1,"micro-text","fw-ligh"],[1,"bi","bi-check-circle"],["label","Progresso","sufix","%","icon","bi bi-clock","controlName","progresso","labelInfo","Progresso de execu\xE7\xE3o (% Conclu\xEDdo)",3,"size","decimals","control"],["controlName","etiquetas",3,"size","control","addItemHandle"],["label","Etiqueta","controlName","etiqueta","nullable","","itemNull","- Selecione -","detailsButton","","detailsButtonIcon","bi bi-tools",3,"details","size","control","items"],["scale","small",3,"size","source","path"],[3,"documento"],[1,"d-block"],[3,"data","color","icon","label",4,"ngFor","ngForOf"],["origem","ATIVIDADE",3,"entity","selectable","grid",4,"ngIf"],[3,"data","color","icon","label"],["origem","ATIVIDADE",3,"entity","selectable","grid"],[3,"label","color"],["origem","PLANO_TRABALHO_ENTREGA",3,"entity"],["color","light",3,"label"],["icon","bi bi-graph-up-arrow","color","light","hint","Meta",3,"textValue"],["icon","bi bi-check-lg","color","light","hint","Realizado",3,"textValue"],[3,"color","icon","label"],["color","success",3,"icon","label","textValue"],["label","","icon","","controlName","unidade_id",3,"size","dao"]],template:function(a,t){if(a&1&&(c(0,"separator",27)(1,"grid",28,0)(3,"columns")(4,"column",29),_(5,Oi,1,1,"ng-template",null,1,f)(7,eo,27,43,"ng-template",null,2,f),d(),c(9,"column",30),_(10,to,1,2,"ng-template",null,3,f),d(),c(12,"column",31),_(13,ao,5,3,"ng-template",null,4,f),d(),c(15,"column",32),_(16,io,1,1,"ng-template",null,5,f),d(),c(18,"column",33),_(19,oo,3,2,"ng-template",null,6,f),d(),c(21,"column",34),_(22,no,1,1,"ng-template",null,7,f),d(),m(24,"column",35),d()()(),c(25,"separator",27)(26,"grid",36,8)(28,"columns"),m(29,"column",37)(30,"column",38)(31,"column",39)(32,"column",35),d()()(),c(33,"separator",27)(34,"grid",40,9)(36,"columns"),m(37,"column",37)(38,"column",38),c(39,"column",41),_(40,ro,2,4,"ng-template",null,10,f),d(),m(42,"column",35),d()()(),c(43,"separator",27)(44,"grid",42,11)(46,"columns"),m(47,"column",43),c(48,"column",44),_(49,lo,1,3,"ng-template",null,12,f)(51,so,2,2,"ng-template",null,13,f),d(),m(53,"column",45)(54,"column",35),d()()()),a&2){let l=h(6),p=h(8),g=h(11),D=h(14),C=h(17),q=h(20),x=h(23),j=h(41),ie=h(50),de=h(52);n("collapsed",!1)("title",t.lex.translate("Atividades"))("icon",t.entityService.getIcon("Atividade")),s(),n("items",t.itemsEntregas)("minHeight",0)("hasEdit",!1),s(3),n("width",50)("icon",t.entityService.getIcon("PlanoTrabalhoConsolidacao"))("align","center")("hint",t.lex.translate("Consolida\xE7\xE3o"))("template",l)("expandTemplate",p),s(5),n("template",g)("width",200),s(3),n("template",D),s(3),n("template",C)("width",100)("titleHint","% Carga Hor\xE1ria Dispon\xEDvel Planejada"),s(3),n("title","Meta")("template",q)("width",100),s(3),n("template",x)("width",150),s(3),n("dynamicButtons",t.dynamicButtons.bind(t)),s(),n("collapsed",!1)("title",t.lex.translate("Ocorr\xEAncias"))("icon",t.entityService.getIcon("PlanoTrabalhoConsolidacao")),s(),n("items",t.itemsOcorrencias)("minHeight",0)("hasDelete",!1)("hasEdit",!1)("hasAdd",!t.disabled)("add",t.addOcorrencia.bind(t)),s(3),n("width",300),s(),n("width",300),s(2),n("dynamicButtons",t.ocorrenciaDynamicButtons.bind(t)),s(),n("collapsed",!1)("title",t.lex.translate("Afastamentos"))("icon",t.entityService.getIcon("Afastamento")),s(),n("items",t.itemsAfastamentos)("minHeight",0)("hasEdit",!1)("hasDelete",!1)("hasAdd",!t.disabled)("add",t.addAfastamento.bind(t)),s(3),n("width",300),s(),n("width",300),s(),n("template",j),s(3),n("dynamicButtons",t.afastamentoDynamicButtons.bind(t)),s(),n("collapsed",!1)("title",t.lex.translate("Comparecimentos"))("icon",t.entityService.getIcon("Comparecimento")),s(),n("items",t.itemsComparecimentos)("minHeight",0)("form",t.formComparecimento)("hasDelete",!t.disabled)("hasAdd",!t.disabled)("hasEdit",!t.disabled)("add",t.addComparecimento.bind(t))("load",t.loadComparecimento.bind(t))("remove",t.removeComparecimento.bind(t))("save",t.saveComparecimento.bind(t)),s(3),n("width",300),s(),n("template",ie)("editTemplate",de),s(6),n("dynamicButtons",t.comparecimentoDynamicButtons.bind(t))}},dependencies:[re,z,k,K,Z,ee,L,Le,le,be,Ut,Q,G,Mt,qt,Be,Wt,Me,Yt]});let o=r;return o})();function mo(o,r){}function po(o,r){if(o&1&&m(0,"plano-trabalho-consolidacao-form",17,7),o&2){let i=r.row,e=u();n("disabled",e.isDisabled(i))("entity",i)("planoTrabalho",e.entity)("cdRef",e.cdRef)}}function uo(o,r){if(o&1&&v(0),o&2){let i=r.row,e=u();P(" ",e.util.getDateFormatted(i.data_inicio)," ")}}function _o(o,r){if(o&1&&v(0),o&2){let i=r.row,e=u();P(" ",e.util.getDateFormatted(i.data_fim)," ")}}function ho(o,r){if(o&1){let i=O();c(0,"avaliar-nota-badge",20),w("click",function(){I(i);let a=u().row,t=u();return S(t.mostrarAvaliacao(a))}),d()}if(o&2){let i=u().row,e=u();n("align","left")("tipoAvaliacao",i.avaliacao.tipo_avaliacao||e.entity.programa.tipo_avaliacao_plano_trabalho)("nota",i.avaliacao.nota)}}function fo(o,r){if(o&1&&(c(0,"separator",21)(1,"small"),v(2),d()()),o&2){let i=u().row;n("collapsed",!1),s(2),A(i.avaliacao.recurso)}}function go(o,r){if(o&1&&_(0,ho,1,3,"avaliar-nota-badge",18)(1,fo,3,2,"separator",19),o&2){let i=r.row;n("ngIf",i.avaliacao),s(),n("ngIf",i.avaliacao==null||i.avaliacao.recurso==null?null:i.avaliacao.recurso.length)}}function bo(o,r){o&1&&m(0,"badge",25)}function vo(o,r){if(o&1&&(c(0,"div",22),m(1,"badge",23),_(2,bo,1,0,"badge",24),d()),o&2){let i=r.row,e=u();s(),n("color",e.lookup.getColor(e.lookup.CONSOLIDACAO_STATUS,i.status))("icon",e.lookup.getIcon(e.lookup.CONSOLIDACAO_STATUS,i.status))("label",e.lookup.getValue(e.lookup.CONSOLIDACAO_STATUS,i.status)),s(),n("ngIf",i.avaliacao==null||i.avaliacao.recurso==null?null:i.avaliacao.recurso.length)}}var Ke=(()=>{let r=class r extends Y{set entity(e){super.entity=e}get entity(){return super.entity}get items(){return this.entity?.consolidacoes||[]}constructor(e){super(e),this.injector=e,this.validate=(a,t)=>null,this.dao=e.get(he),this.avaliacaoDao=e.get(Qe),this.planoTrabalhoService=e.get(te),this.unidadeService=e.get(_e),this.planoTrabalhoDao=e.get(X),this.title=this.lex.translate("Consolida\xE7\xF5es"),this.code="MOD_PTR_CSLD",this.modalWidth=1200,this.form=this.fh.FormBuilder({data_inicio:{default:new Date},data_fim:{default:new Date}},this.cdRef,this.validate)}ngAfterViewInit(){super.ngAfterViewInit(),b(this,null,function*(){if(this.urlParams?.has("usuarioId")&&this.urlParams?.has("planoTrabalhoId")){let a=yield this.planoTrabalhoDao.getByUsuario(this.urlParams.get("usuarioId"),!0,this.urlParams.get("planoTrabalhoId"));a.planos.length==1&&(this.entity=a.planos[0])}let e=new Date().getTime();this.items.forEach(a=>{a.plano_trabalho||(a.plano_trabalho=this.entity),this.util.asTimestamp(a.data_inicio)<=e&&e<=this.util.asTimestamp(a.data_fim)&&this.grid.expand(a.id)})})}addConsolidacao(){return b(this,null,function*(){return new Te({id:this.dao.generateUuid(),plano_trabalho_id:this.entity.id})})}loadConsolidacao(e,a){return b(this,null,function*(){this.form.patchValue({data_inicio:a.data_inicio,data_fim:a.data_fim}),this.cdRef.detectChanges()})}removeConsolidacao(e){return b(this,null,function*(){if(yield this.dialog.confirm("Exclui ?","Deseja realmente excluir o item ?"))try{let t=e;return yield this.dao?.delete(t),this.items.splice(this.items.findIndex(l=>l.id==t.id),1),!0}catch{return!1}else return!1})}saveConsolidacao(e,a){return b(this,null,function*(){let t;return this.form.markAllAsTouched(),this.form.valid&&(a.id=a.id=="NEW"?this.dao.generateUuid():a.id,a.data_inicio=e.controls.data_inicio.value,a.data_fim=e.controls.data_fim.value,t=yield this.dao?.save(a)),t})}refreshConsolidacao(e,a){a&&e._metadata?.planoTrabalhoConsolidacaoFormComponent?(e._metadata?.planoTrabalhoConsolidacaoFormComponent).loadConsolidacao(a):this.grid.refreshExpanded(e.id),this.grid.refreshRows()}concluir(e){return b(this,null,function*(){this.submitting=!0;try{let a=yield this.dao.concluir(e.id);e.status=a.status,this.refreshConsolidacao(e,a)}catch(a){this.error(a.message||a)}finally{this.submitting=!1}})}cancelarConclusao(e){return b(this,null,function*(){this.submitting=!0;try{let a=yield this.dao.cancelarConclusao(e.id);e.status=a.status,this.refreshConsolidacao(e,a)}catch(a){this.error(a.message||a)}finally{this.submitting=!1}})}anterior(e){return this.entity.consolidacoes.reduce((a,t)=>this.util.asTimestamp(t.data_inicio)<this.util.asTimestamp(e.data_inicio)&&(!a||this.util.asTimestamp(a.data_inicio)<this.util.asTimestamp(t.data_inicio))?t:a,void 0)}proximo(e){return this.entity.consolidacoes.reduce((a,t)=>this.util.asTimestamp(t.data_fim)>this.util.asTimestamp(e.data_fim)&&(!a||this.util.asTimestamp(a.data_fim)>this.util.asTimestamp(t.data_fim))?t:a,void 0)}isDisabled(e){return e&&e.status!="INCLUIDO"||this.entity?.status!="ATIVO"}podeInserir(){return this.auth.hasPermissionTo("MOD_PTR_CSLD_INCL")}dynamicButtons(e){let a=[],t=e,l=t.plano_trabalho?.usuario_id,p=this.entity.unidade_id,g=t?.avaliacoes.filter(W=>W.recurso!=null).length>0,D=this.auth.usuario.id==l,C={gestor:!1,gestorSubstituto:!1,gestorDelegado:!1},q=this.entity?._metadata.atribuicoesGestorUsuarioLogado||C,x=this.entity?._metadata.atribuicoesGestorUsuario||C,j=this.entity?._metadata.gestorUnidadeSuperior||C,ie=!D&&this.auth.hasPermissionTo("MOD_PTR_CSLD_AVAL")&&(this.auth.isIntegrante("AVALIADOR_PLANO_TRABALHO",p)||x.gestor&&(j.gestor||j.gestorSubstituto)||x.gestorSubstituto&&(q.gestor||j.gestor||j.gestorSubstituto)||!x.gestor&&!x.gestorSubstituto&&(q.gestor||q.gestorSubstituto)),de={hint:"Concluir",icon:"bi bi-check-circle",color:"btn-outline-success",onClick:this.concluir.bind(this)},Ee={hint:"Cancelar conclus\xE3o",icon:"bi bi-backspace",color:"btn-outline-danger",onClick:this.cancelarConclusao.bind(this)},ne={hint:"Avaliar",icon:"bi bi-star",color:"btn-outline-warning",onClick:W=>this.planoTrabalhoService.avaliar(W,this.entity.programa,this.refreshConsolidacao.bind(this))},Ye={hint:"Reavaliar",icon:"bi bi-star-half",color:"btn-outline-warning",onClick:W=>this.planoTrabalhoService.avaliar(W,this.entity.programa,this.refreshConsolidacao.bind(this))},et={label:"Recurso",id:"RECORRIDO",icon:"bi bi-journal-medical",color:"btn-outline-warning",onClick:W=>this.planoTrabalhoService.fazerRecurso(W,this.entity.programa,this.refreshConsolidacao.bind(this))},tt={hint:"Cancelar avalia\xE7\xE3o",id:"INCLUIDO",icon:"bi bi-backspace",color:"btn-outline-danger",onClick:W=>this.planoTrabalhoService.cancelarAvaliacao(W,this,this.refreshConsolidacao.bind(this))};return t.status=="INCLUIDO"&&(D||this.auth.hasPermissionTo("MOD_PTR_CSLD_CONCL"))&&a.push(de),t.status=="CONCLUIDO"&&(D||this.auth.hasPermissionTo("MOD_PTR_CSLD_DES_CONCL"))&&a.push(Ee),t.status=="CONCLUIDO"&&ie&&a.push(ne),t.status=="AVALIADO"&&t.avaliacao&&(D&&!g&&this.auth.hasPermissionTo("MOD_PTR_CSLD_REC_AVAL")&&t.avaliacao?.data_avaliacao&&a.push(et),ie&&(a.push(Ye),a.push(tt))),a}mostrarAvaliacao(e){this.planoTrabalhoService.fazerRecurso(e,this.entity.programa,this.refreshConsolidacao.bind(this))}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["plano-trabalho-consolidacao-list"]],viewQuery:function(a,t){if(a&1&&y(k,5),a&2){let l;T(l=E())&&(t.grid=l.first)}},inputs:{entity:"entity"},features:[U],decls:24,vars:20,consts:[["grid",""],["columnConsolidacao",""],["columnExpandedConsolidacao",""],["columnDataInicio",""],["columnDataFim",""],["columnEstatisticas",""],["columnStatus",""],["consolidacao",""],["editable","",3,"items","form","hasDelete","minHeight","add","hasAdd","hasEdit"],[1,"my-2"],[1,"bi","bi-arrow-down"],["type","expand",3,"icon","align","hint","template","expandTemplate"],["title","Data in\xEDcio",3,"template"],["title","Data fim",3,"template"],["title","Estat\xEDsticas/Avalia\xE7\xF5es",3,"template","width"],["title","Status",3,"template"],["type","options",3,"dynamicButtons"],[3,"disabled","entity","planoTrabalho","cdRef"],[3,"align","tipoAvaliacao","nota","click",4,"ngIf"],["title","Recurso da avalia\xE7\xE3o","collapse","",3,"collapsed",4,"ngIf"],[3,"click","align","tipoAvaliacao","nota"],["title","Recurso da avalia\xE7\xE3o","collapse","",3,"collapsed"],[1,"one-per-line"],[3,"color","icon","label"],["icon","bi bi-journal-medical","color","warning","label","Recorrido",4,"ngIf"],["icon","bi bi-journal-medical","color","warning","label","Recorrido"]],template:function(a,t){if(a&1&&(c(0,"grid",8,0)(2,"h5",9),v(3),m(4,"i",10),d(),c(5,"columns")(6,"column",11),_(7,mo,0,0,"ng-template",null,1,f)(9,po,2,4,"ng-template",null,2,f),d(),c(11,"column",12),_(12,uo,1,1,"ng-template",null,3,f),d(),c(14,"column",13),_(15,_o,1,1,"ng-template",null,4,f),d(),c(17,"column",14),_(18,go,2,2,"ng-template",null,5,f),d(),c(20,"column",15),_(21,vo,3,4,"ng-template",null,6,f),d(),m(23,"column",16),d()()),a&2){let l=h(8),p=h(10),g=h(13),D=h(16),C=h(19),q=h(22);n("items",t.items)("form",t.form)("hasDelete",!0)("minHeight",0)("add",t.addConsolidacao.bind(t))("hasAdd",!1)("hasEdit",!1)("hasDelete",!1),s(3),P("",t.lex.translate("Consolida\xE7\xF5es")," "),s(3),n("icon",t.entityService.getIcon("PlanoTrabalhoConsolidacao"))("align","center")("hint",t.lex.translate("Consolida\xE7\xE3o"))("template",l)("expandTemplate",p),s(5),n("template",g),s(3),n("template",D),s(3),n("template",C)("width",300),s(3),n("template",q),s(3),n("dynamicButtons",t.dynamicButtons.bind(t))}},dependencies:[z,k,K,Z,Q,G,He,Ze]});let o=r;return o})();var yo=["accordion"];function To(o,r){if(o&1&&m(0,"badge",13),o&2){let i=r.$implicit;n("badge",i)}}function Eo(o,r){if(o&1&&(c(0,"div",4)(1,"div",5),v(2),d(),c(3,"div",6),m(4,"badge",10)(5,"badge",10)(6,"badge",10)(7,"badge",10),d(),c(8,"div",7),v(9),d(),c(10,"div",8),_(11,To,1,1,"badge",11),d(),c(12,"div",8),m(13,"badge",12),d()()),o&2){let i=r.item,e=u();s(2),A("#"+i.numero),s(2),n("icon",e.entityService.getIcon("Usuario"))("label",i.usuario==null?null:i.usuario.nome)("hint",e.lex.translate("Participante")+": "+(i.usuario==null?null:i.usuario.nome)),s(),n("icon",e.entityService.getIcon("Unidade"))("label",i.unidade==null?null:i.unidade.sigla)("hint",e.lex.translate("Unidade")+": "+(i.unidade==null?null:i.unidade.nome)),s(),n("icon",e.entityService.getIcon("Programa"))("label",i.programa==null?null:i.programa.nome)("hint",e.lex.translate("Programa")),s(),n("icon",e.entityService.getIcon("TipoModalidade"))("label",i.tipo_modalidade==null?null:i.tipo_modalidade.nome)("hint",e.lex.translate("Tipo de modalidade")),s(2),P(" ",e.dao.getDateFormatted(i.data_inicio)+" at\xE9 "+e.dao.getDateFormatted(i.data_fim)," "),s(2),n("ngForOf",e.getPlanoBadges(i)),s(2),n("label",e.lookup.getValue(e.lookup.PLANO_TRABALHO_STATUS,i.status))("icon",e.lookup.getIcon(e.lookup.PLANO_TRABALHO_STATUS,i.status))("color",e.lookup.getColor(e.lookup.PLANO_TRABALHO_STATUS,i.status))}}function xo(o,r){if(o&1&&m(0,"plano-trabalho-consolidacao-list",14),o&2){let i=r.item;n("entity",i)}}var ca=(()=>{let r=class r extends Y{set arquivados(e){this._arquivados!=e&&(this._arquivados=e,this.viewInit&&this.loadData(this.entity,this.form))}get arquivados(){return this._arquivados}constructor(e){super(e),this.injector=e,this.selectedIndex=-1,this.planos=[],this._arquivados=!1,this.dao=e.get(X)}ngAfterViewInit(){super.ngAfterViewInit(),b(this,null,function*(){yield this.loadData(this.entity,this.form)})}loadData(e,a){return b(this,null,function*(){this.accordion.loading=!0;try{let l=yield this.dao.getByUsuario(this.usuarioId,this.arquivados),p=new Date().getTime(),g=this;this.planos=l.planos;for(var t=0;t<this.planos.length;t++)this.util.asTimestamp(this.planos[t].data_inicio)<=p&&p<=this.util.asTimestamp(this.planos[t].data_fim)&&["ATIVO","CONCLUIDO"].includes(this.planos[t].status)&&(this.selectedIndex=t)}finally{this.accordion.loading=!1,this.cdRef.detectChanges()}})}getPlanoBadges(e){let a=[],t=e.consolidacoes.filter(p=>p.status=="CONCLUIDO"),l=e.consolidacoes.filter(p=>p.status=="AVALIADO");if(t.length){let p=this.lookup.getLookup(this.lookup.CONSOLIDACAO_STATUS,"CONCLUIDO");a.push({icon:p?.icon,label:p?.value,color:p?.color,textValue:t.length.toString()})}if(l.length){let p=this.lookup.getLookup(this.lookup.CONSOLIDACAO_STATUS,"AVALIADO");a.push({icon:p?.icon,label:p?.value,color:p?.color,textValue:l.length.toString()})}return JSON.stringify(e._metadata?.badges)!=this.JSON.stringify(a)&&(e._metadata=Object.assign(e._metadata||{},{badges:a})),e._metadata.badges}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["plano-trabalho-list-accordeon"]],viewQuery:function(a,t){if(a&1&&y(yo,5),a&2){let l;T(l=E())&&(t.accordion=l.first)}},inputs:{usuarioId:"usuarioId",arquivados:"arquivados"},features:[U],decls:17,vars:8,consts:[["accordion",""],["planoTrabalhoSectionTitle",""],["planoTrabalhoSection",""],[1,"p-3","bg-body-secondary","mb-3"],[1,"row","w-100"],[1,"col-md-1"],[1,"col-md-4"],[1,"col-md-3"],[1,"col-md-2"],[3,"items","selectedIndex","titleTemplate","template"],["color","light",3,"icon","label","hint"],[3,"badge",4,"ngFor","ngForOf"],[3,"label","icon","color"],[3,"badge"],[3,"entity"]],template:function(a,t){if(a&1&&(c(0,"div",3)(1,"div",4)(2,"div",5),v(3,"#ID"),d(),c(4,"div",6),v(5),d(),c(6,"div",7),v(7,"Vig\xEAncia"),d(),m(8,"div",8),c(9,"div",8),v(10,"Status"),d()()(),c(11,"accordion",9,0),_(13,Eo,14,18,"ng-template",null,1,f)(15,xo,1,1,"ng-template",null,2,f),d()),a&2){let l=h(14),p=h(16);s(5),ut("",t.lex.translate("Participante"),"/",t.lex.translate("Unidade"),"/",t.lex.translate("Programa"),"/",t.lex.translate("Tipo de modalidade"),""),s(6),n("items",t.planos)("selectedIndex",t.selectedIndex)("titleTemplate",l)("template",p)}},dependencies:[re,G,Ht,Ke]});let o=r;return o})();function So(o,r){o&1&&(c(0,"div",17)(1,"div",18),m(2,"span",19),d()())}function Ao(o,r){if(o&1&&(c(0,"div",21)(1,"div",22),m(2,"profile-picture",23),d(),c(3,"div",24)(4,"strong"),v(5),d(),m(6,"br"),c(7,"small"),v(8),d()()()),o&2){let i=r.data;s(2),n("url",i.url_foto)("size",40)("hint",i.nome),s(3),A(i.nome||""),s(3),A(i.apelido||"")}}function wo(o,r){if(o&1&&m(0,"plano-trabalho-list-accordeon",25),o&2){let i=r.data;n("usuarioId",i.id)}}function Po(o,r){if(o&1&&(c(0,"collapse-card",20),_(1,Ao,9,5,"ng-template",null,4,f)(3,wo,1,1,"ng-template",null,5,f),d()),o&2){let i=r.$implicit,e=h(2),a=h(4);n("data",i)("titleTemplate",e)("template",a)}}function Ro(o,r){if(o&1&&(c(0,"filter",10)(1,"div",11),m(2,"input-search",12,3),d()(),c(4,"div",13)(5,"h5"),v(6),d(),c(7,"h4"),v(8),m(9,"i",14),d()(),_(10,So,3,0,"div",15)(11,Po,5,3,"collapse-card",16)),o&2){let i=h(3),e=u(2);n("form",e.filter)("filter",e.filterWhere)("collapsed",!1),s(2),n("size",12)("control",e.filter.controls.unidade_id)("dao",e.unidadeDao),s(4),pt("",e.lex.translate("Unidade")," selecionada: ",i==null||i.selectedItem==null?null:i.selectedItem.entity.sigla," - ",i==null||i.selectedItem==null?null:i.selectedItem.entity.nome,""),s(2),P("",e.lex.translate("Participantes")," "),s(2),n("ngIf",e.loading),s(),n("ngForOf",e.usuarios)}}function Oo(o,r){if(o&1&&(c(0,"tab",9),_(1,Ro,12,12,"ng-template",null,2,f),d()),o&2){let i=h(2),e=u();n("icon",e.entityService.getIcon("Unidade"))("label",e.lex.translate("Unidade"))("template",i)}}function Fo(o,r){if(o&1&&(c(0,"div",26)(1,"h5",27),v(2),m(3,"i",14),d(),m(4,"separator",28),d(),m(5,"plano-trabalho-list-accordeon",29)),o&2){let i=u();s(2),P("",i.lex.translate("Planos de Trabalho")," "),s(2),n("control",i.form.controls.arquivados)("title","Mostrar "+i.lex.translate("Planos de trabalho")+" arquivados?"),s(),n("usuarioId",i.auth.usuario.id)("arquivados",i.form.controls.arquivados.value)}}var pa=(()=>{let r=class r extends Y{constructor(e){super(e),this.injector=e,this.usuarios=[],this.loadingUnidade=!1,this.filterWhere=a=>{let t=a.value;this.loadUsuarios(t.unidade_id)},this.unidadeDao=e.get($),this.form=this.fh.FormBuilder({arquivados:{default:!1}}),this.filter=this.fh.FormBuilder({unidade_id:{default:!1}})}ngAfterViewInit(){super.ngAfterViewInit(),this.tabs.active=this.queryParams?.tab||"USUARIO",this.tabs.title=this.lex.translate("Consolida\xE7\xF5es"),b(this,null,function*(){yield this.loadData(this.entity,this.form)})}loadData(e,a){return b(this,null,function*(){this.unidade=this.auth.unidadeGestor(),this.filter.controls.unidade_id.setValue(this.unidade?.id||this.auth.lotacao||null),this.unidade&&(yield this.loadUsuarios(this.unidade.id))})}loadUsuarios(e){return b(this,null,function*(){this.usuarios=[],this.loadingUnidade=!0,this.loading=!0,this.cdRef.detectChanges();try{this.usuarios=yield this.unidadeDao.lotados(e)}finally{this.loading=!1,this.loadingUnidade=!1,this.cdRef.detectChanges()}})}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["app-plano-trabalho-consolidacao"]],viewQuery:function(a,t){if(a&1&&(y(se,5),y(L,5)),a&2){let l;T(l=E())&&(t.tabs=l.first),T(l=E())&&(t.unidadeSelecionada=l.first)}},features:[U],decls:6,vars:5,consts:[["tabs",""],["tabUsuario",""],["tabUnidade",""],["unidadeSelecionada",""],["usuarioCardTitle",""],["usuarioCard",""],["right","",3,"title"],["key","UNIDADE",3,"icon","label","template",4,"ngIf"],["key","USUARIO",3,"icon","label","template"],["key","UNIDADE",3,"icon","label","template"],[3,"form","filter","collapsed"],[1,"row"],["label","Selecione a unidade","controlName","unidade_id",3,"size","control","dao"],[1,"p-3","mb-3","bg-body-secondary"],[1,"bi","bi-arrow-down"],["class","d-flex justify-content-center my-2",4,"ngIf"],[3,"data","titleTemplate","template",4,"ngFor","ngForOf"],[1,"d-flex","justify-content-center","my-2"],["role","status",1,"spinner-border"],[1,"visually-hidden"],[3,"data","titleTemplate","template"],[1,"d-flex"],[1,"ms-3"],[3,"url","size","hint"],[1,"flex-fill","ms-3"],[3,"usuarioId"],[1,"d-flex","justify-content-between"],[1,"mt-2"],[3,"control","title"],[3,"usuarioId","arquivados"]],template:function(a,t){if(a&1&&(c(0,"tabs",6,0),_(2,Oo,3,3,"tab",7),c(3,"tab",8),_(4,Fo,6,5,"ng-template",null,1,f),d()()),a&2){let l=h(5);n("title",t.isModal?"":t.title),s(2),n("ngIf",t.unidade),s(),n("icon",t.entityService.getIcon("Usuario"))("label",t.lex.translate("Usu\xE1rio"))("template",l)}},dependencies:[re,z,ge,L,se,ve,Q,ze,Gt,ca]});let o=r;return o})();function ko(o,r){if(o&1&&(c(0,"div",42)(1,"div",43),m(2,"profile-picture",44),d(),c(3,"div",45)(4,"strong"),v(5),d(),m(6,"br")(7,"badge",46),d()()),o&2){let i,e,a,t,l=r.separator,p=u(2);s(2),n("url",(i=p.usuarioSeparator(l))==null?null:i.url_foto)("size",40)("hint",(e=p.usuarioSeparator(l))==null?null:e.nome),s(3),A(((a=p.usuarioSeparator(l))==null?null:a.nome)||"Desconhecido"),s(2),n("icon",p.entityService.getIcon("Unidade"))("label",((t=p.unidadeSeparator(l))==null?null:t.sigla)||"Desconhecido")}}function Lo(o,r){o&1&&m(0,"toolbar")}function qo(o,r){}function No(o,r){if(o&1&&m(0,"plano-trabalho-consolidacao-form",47,14),o&2){let i=r.row,e=u(2);n("disabled",!0)("entity",i)("planoTrabalho",i.plano_trabalho)("cdRef",e.cdRef)}}function zo(o,r){if(o&1&&(v(0),m(1,"badge",48)(2,"badge",49)(3,"badge",50)),o&2){let i=r.row,e=u(2);P(" #",i.plano_trabalho==null?null:i.plano_trabalho.numero," "),s(),n("textValue",e.util.getDateFormatted(i.plano_trabalho==null?null:i.plano_trabalho.data_inicio)),s(),n("textValue",e.util.getDateFormatted(i.plano_trabalho==null?null:i.plano_trabalho.data_fim)),s(),n("icon",e.entityService.getIcon("TipoModalidade"))("label",i.plano_trabalho==null||i.plano_trabalho.tipo_modalidade==null?null:i.plano_trabalho.tipo_modalidade.nome)("hint",e.lex.translate("Tipo de modalidade"))}}function Bo(o,r){if(o&1&&v(0),o&2){let i=r.row,e=u(2);P(" ",e.util.getDateFormatted(i.data_inicio)," ")}}function Mo(o,r){if(o&1&&(c(0,"strong"),v(1),d()),o&2){let i=r.row,e=u(2);s(),A(e.util.getDateFormatted(i.data_fim))}}function Qo(o,r){if(o&1&&m(0,"avaliar-nota-badge",53),o&2){let i=u().row;n("align","left")("tipoAvaliacao",i.avaliacao.tipo_avaliacao)("nota",i.avaliacao.nota)}}function Ho(o,r){if(o&1&&(c(0,"separator",54)(1,"small"),v(2),d()()),o&2){let i=u().row;n("collapsed",!1),s(2),A(i.avaliacao.recurso)}}function Go(o,r){if(o&1&&_(0,Qo,1,3,"avaliar-nota-badge",51)(1,Ho,3,2,"separator",52),o&2){let i=r.row;n("ngIf",i.avaliacao),s(),n("ngIf",i.avaliacao==null||i.avaliacao.recurso==null?null:i.avaliacao.recurso.length)}}function jo(o,r){o&1&&m(0,"badge",58)}function Wo(o,r){if(o&1&&(c(0,"div",55),m(1,"badge",56),_(2,jo,1,0,"badge",57),d()),o&2){let i=r.row,e=u(2);s(),n("color",e.lookup.getColor(e.lookup.CONSOLIDACAO_STATUS,i.status))("icon",e.lookup.getIcon(e.lookup.CONSOLIDACAO_STATUS,i.status))("label",e.lookup.getValue(e.lookup.CONSOLIDACAO_STATUS,i.status)),s(),n("ngIf",i.avaliacao==null||i.avaliacao.recurso==null?null:i.avaliacao.recurso.length)}}function Jo(o,r){if(o&1){let i=O();c(0,"grid",26),_(1,ko,8,6,"ng-template",null,2,f)(3,Lo,1,0,"toolbar",27),c(4,"filter",28)(5,"div",29),m(6,"input-search",30,3),c(8,"input-search",31,4),w("change",function(a){I(i);let t=u();return S(t.onUnidadeChange(a))}),d(),m(10,"input-switch",32,5)(12,"input-switch",33,6),d()(),c(14,"columns")(15,"column",34),_(16,qo,0,0,"ng-template",null,7,f)(18,No,2,4,"ng-template",null,8,f),d(),c(20,"column",35),_(21,zo,4,6,"ng-template",null,9,f),d(),c(23,"column",36),_(24,Bo,1,1,"ng-template",null,10,f),d(),c(26,"column",37),_(27,Mo,2,1,"ng-template",null,11,f),d(),c(29,"column",38),_(30,Go,2,2,"ng-template",null,12,f),d(),c(32,"column",39),_(33,Wo,3,4,"ng-template",null,13,f),d(),m(35,"column",40),d(),m(36,"pagination",41),d()}if(o&2){let i=h(2),e=h(17),a=h(19),t=h(22),l=h(25),p=h(28),g=h(31),D=h(34),C=u();n("dao",C.dao)("orderBy",C.orderBy)("groupBy",C.groupBy)("join",C.join)("init",C.initGrid.bind(C))("hasAdd",!1)("hasEdit",!1)("loadList",C.onGridLoad.bind(C))("groupTemplate",i),s(3),n("ngIf",!C.selectable),s(),n("form",C.filter)("where",C.filterWhere)("submit",C.filterSubmit.bind(C))("collapseChange",C.filterCollapseChange.bind(C))("collapsed",C.filterCollapsed)("deleted",C.auth.hasPermissionTo("MOD_AUDIT_DEL")),s(2),n("size",5)("control",C.filter.controls.usuario_id)("dao",C.usuarioDao),s(2),n("size",5)("control",C.filter.controls.unidade_id)("dao",C.unidadeDao),s(2),n("size",1)("disabled",C.canFilterSubordinadas)("control",C.filter.controls.unidades_subordinadas),s(2),n("size",1)("control",C.filter.controls.incluir_arquivados),s(3),n("icon",C.entityService.getIcon("PlanoTrabalhoConsolidacao"))("align","center")("hint",C.lex.translate("Consolida\xE7\xE3o"))("template",e)("expandTemplate",a),s(5),n("title","Plano de trabalho/Vig\xEAncia/Modalidade")("template",t),s(3),n("template",l),s(3),n("template",p),s(3),n("title",`Estat\xEDsticas
Avalia\xE7\xF5es`)("template",g)("width",300),s(3),n("template",D),s(3),n("dynamicButtons",C.dynamicButtons.bind(C)),s(),n("rows",C.rowsLimit)}}function $o(o,r){if(o&1&&(c(0,"div",42)(1,"div",43),m(2,"profile-picture",44),d(),c(3,"div",45)(4,"strong"),v(5),d(),m(6,"br")(7,"badge",46),d()()),o&2){let i,e,a,t,l=r.separator,p=u(2);s(2),n("url",(i=p.usuarioSeparator(l))==null?null:i.url_foto)("size",40)("hint",(e=p.usuarioSeparator(l))==null?null:e.nome),s(3),A(((a=p.usuarioSeparator(l))==null?null:a.nome)||"Desconhecido"),s(2),n("icon",p.entityService.getIcon("Unidade"))("label",((t=p.unidadeSeparator(l))==null?null:t.sigla)||"Desconhecido")}}function Xo(o,r){o&1&&m(0,"toolbar")}function Zo(o,r){}function Ko(o,r){if(o&1&&(c(0,"div",64)(1,"div",65),m(2,"profile-picture",44),d(),c(3,"div",66)(4,"strong"),v(5),d(),m(6,"br"),c(7,"small"),v(8),d()()()),o&2){let i=r.row;s(2),n("url",i.avaliador.url_foto||"")("size",40)("hint",i.avaliador.nome||""),s(3),A(i.avaliador.nome||""),s(3),A(i.avaliador.apelido||"")}}function Yo(o,r){if(o&1&&(m(0,"badge",67)(1,"br"),c(2,"small"),v(3),d()),o&2){let i=r.row,e=u(3);n("label",e.getNota(i).nota)("icon",e.getNota(i).icone)("color",e.getNota(i).cor),s(3),A(e.getNota(i).descricao)}}function en(o,r){if(o&1&&m(0,"badge",69),o&2){let i=r.$implicit,e=u(4);n("icon",e.entityService.getIcon("TipoJustificativa"))("label",i.value)}}function tn(o,r){if(o&1&&(v(0),c(1,"div",55),_(2,en,1,2,"badge",68),d()),o&2){let i=r.row;P(" ",i.justificativa||""," "),s(2),n("ngForOf",i.justificativas)}}function an(o,r){if(o&1&&(c(0,"small"),v(1),d()),o&2){let i=r.row;s(),A(i.recurso||"")}}function on(o,r){o&1&&m(0,"badge",58)}function nn(o,r){o&1&&m(0,"badge",71)}function rn(o,r){if(o&1&&(c(0,"div",55),_(1,on,1,0,"badge",57)(2,nn,1,0,"badge",70),d()),o&2){let i=r.row,e=u(3);s(),n("ngIf",i.recurso==null?null:i.recurso.length),s(),n("ngIf",i.id==(e.avaliacao==null?null:e.avaliacao.id))}}function ln(o,r){if(o&1&&(c(0,"grid",60,18)(2,"columns"),m(3,"column",61),c(4,"column",62),_(5,Ko,9,5,"ng-template",null,19,f),d(),c(7,"column",35),_(8,Yo,4,4,"ng-template",null,20,f),d(),c(10,"column",35),_(11,tn,3,2,"ng-template",null,21,f),d(),c(13,"column",63),_(14,an,2,1,"ng-template",null,22,f),d(),c(16,"column",39),_(17,rn,3,2,"ng-template",null,13,f),d()()()),o&2){let i=r.row,e=h(6),a=h(9),t=h(12),l=h(15),p=h(18),g=u(2);n("items",g.getAvaliacoes(i))("minHeight",0),s(4),n("template",e),s(3),n("title","Nota")("template",a),s(3),n("title","Justificativas")("template",t),s(3),n("template",l),s(3),n("template",p)}}function sn(o,r){if(o&1&&(v(0),m(1,"badge",48)(2,"badge",49)(3,"badge",50)),o&2){let i=r.row,e=u(2);P(" # ",i.plano_trabalho==null?null:i.plano_trabalho.numero," "),s(),n("textValue",e.util.getDateFormatted(i.plano_trabalho.data_inicio)),s(),n("textValue",e.util.getDateFormatted(i.plano_trabalho.data_fim)),s(),n("icon",e.entityService.getIcon("TipoModalidade"))("label",i.plano_trabalho.tipo_modalidade==null?null:i.plano_trabalho.tipo_modalidade.nome)("hint",e.lex.translate("Tipo de modalidade"))}}function dn(o,r){if(o&1&&v(0),o&2){let i=r.row,e=u(2);P(" ",e.util.getDateFormatted(i.data_inicio)," ")}}function cn(o,r){if(o&1&&v(0),o&2){let i=r.row,e=u(2);P(" ",e.util.getDateFormatted(i.data_fim)," ")}}function mn(o,r){if(o&1){let i=O();c(0,"grid",26),_(1,$o,8,6,"ng-template",null,15,f)(3,Xo,1,0,"toolbar",27),c(4,"filter",28)(5,"div",29),m(6,"input-search",30,3),c(8,"input-search",31,4),w("change",function(a){I(i);let t=u();return S(t.onUnidadeChange(a))}),d(),m(10,"input-switch",32,5)(12,"input-switch",33,6),d()(),c(14,"columns")(15,"column",59),_(16,Zo,0,0,"ng-template",null,16,f)(18,ln,19,9,"ng-template",null,17,f),d(),c(20,"column",35),_(21,sn,4,6,"ng-template",null,9,f),d(),c(23,"column",36),_(24,dn,1,1,"ng-template",null,10,f),d(),c(26,"column",37),_(27,cn,1,1,"ng-template",null,11,f),d()(),m(29,"pagination",41),d()}if(o&2){let i=h(2),e=h(17),a=h(19),t=h(22),l=h(25),p=h(28),g=u();n("dao",g.dao)("orderBy",g.orderBy)("groupBy",g.groupBy)("join",g.join)("init",g.initGrid.bind(g))("hasAdd",!1)("hasEdit",!1)("loadList",g.onGridLoadHistorico.bind(g))("groupTemplate",i),s(3),n("ngIf",!g.selectable),s(),n("form",g.filter)("where",g.filterWhereHistorico)("submit",g.filterSubmit.bind(g))("collapseChange",g.filterCollapseChange.bind(g))("collapsed",g.filterCollapsed)("deleted",g.auth.hasPermissionTo("MOD_AUDIT_DEL")),s(2),n("size",5)("control",g.filter.controls.usuario_id)("dao",g.usuarioDao),s(2),n("size",5)("control",g.filter.controls.unidade_id)("dao",g.unidadeDao),s(2),n("size",1)("disabled",g.canFilterSubordinadas)("control",g.filter.controls.unidades_subordinadas),s(2),n("size",1)("control",g.filter.controls.incluir_arquivados),s(3),n("icon",g.entityService.getIcon("PlanoTrabalhoConsolidacao"))("align","center")("template",e)("expandTemplate",a),s(5),n("title","Plano de trabalho/Vig\xEAncia/Modalidade")("template",t),s(3),n("template",l),s(3),n("template",p),s(3),n("rows",g.rowsLimit)}}var ua=(()=>{let r=class r extends zt{constructor(e){super(e,Te,he),this.injector=e,this.avaliacoes=[],this.avaliacao=new $t,this.consolidacaoId=[],this.joinAvaliacao=["avaliador","entregas_checklist","tipo_avaliacao.notas"],this.filterWhere=a=>{let t=[],l=a.value;return t.push(["status","in",["CONCLUIDO","AVALIADO"]]),l.usuario_id?.length&&t.push(["plano_trabalho.usuario.id","==",l.usuario_id]),l.unidade_id?.length&&t.push(["plano_trabalho.unidade.id","==",l.unidade_id]),l.unidades_subordinadas&&t.push(["unidades_subordinadas","==",!0]),l.incluir_arquivados&&t.push(["incluir_arquivados","==",!0]),t},this.filterWhereHistorico=a=>{let t=[],l=a.value;return t.push(["status","in",["AVALIADO"]]),l.usuario_id?.length&&t.push(["plano_trabalho.usuario.id","==",l.usuario_id]),l.unidade_id?.length&&t.push(["plano_trabalho.unidade.id","==",l.unidade_id]),l.unidades_subordinadas&&t.push(["unidades_subordinadas","==",!0]),l.incluir_arquivados&&t.push(["incluir_arquivados","==",!0]),t},this.unidadeService=e.get(_e),this.join=["avaliacao","plano_trabalho:id"],this.extraJoin=["avaliacao.tipoAvaliacao.notas","planoTrabalho.unidade:id,sigla,nome","planoTrabalho.unidade.gestor:id,unidade_id,usuario_id","planoTrabalho.unidade.unidadePai.gestoresSubstitutos:id,unidade_id,usuario_id","planoTrabalho.unidade.unidadePai.gestor:id,unidade_id,usuario_id","planoTrabalho.unidade.gestoresSubstitutos:id,unidade_id,usuario_id","planoTrabalho.tipoModalidade:id,nome","planoTrabalho.usuario:id,nome,apelido,foto_perfil,url_foto"],this.groupBy=[{field:"plano_trabalho.unidade.sigla",label:this.lex.translate("Unidade")},{field:"plano_trabalho.unidade.id",label:"Unidade Id"},{field:"plano_trabalho.usuario.nome",label:this.lex.translate("Participante")},{field:"plano_trabalho.usuario.id",label:"Usu\xE1rio Id"}],this.usuarioDao=e.get(ue),this.unidadeDao=e.get($),this.avaliacaoDao=e.get(Qe),this.planoTrabalhoService=e.get(te),this.title="Avalia\xE7\xF5es "+this.lex.translate("das Consolida\xE7\xF5es"),this.code="MOD_PTR_CSLD_AVAL",this.filter=this.fh.FormBuilder({usuario_id:{default:""},unidade_id:{default:""},unidades_subordinadas:{default:!1},incluir_arquivados:{default:!1}}),this.addOption(this.OPTION_INFORMACOES),this.addOption(this.OPTION_LOGS,"MOD_AUDIT_LOG")}ngOnInit(){super.ngOnInit(),this.filter.controls.unidade_id.setValue(this.auth.unidadeGestor()?.id||this.auth.lotacao||null)}get canFilterSubordinadas(){return this.unidadeService.isGestorUnidade(this.filter.controls.unidade_id.value)?void 0:"true"}usuarioSeparator(e){let a=e.group[3].value;return e.metadata=e.metadata||{},e.metadata.usuario=e.metadata.usuario||this.extra?.planos_trabalhos?.find(t=>t.usuario_id==a)?.usuario,e.metadata.usuario}unidadeSeparator(e){let a=e.group[1].value;return e.metadata=e.metadata||{},e.metadata.unidade=e.metadata.unidade||this.extra?.planos_trabalhos?.find(t=>t.unidade_id==a)?.unidade,e.metadata.unidade}onUnidadeChange(e){this.unidadeService.isGestorUnidade(this.filter.controls.unidade_id.value)||this.filter.controls.unidades_subordinadas.setValue(!1)}onGridLoad(e){this.extra=(this.grid?.query||this.query).extra,(this.extra?.planos_trabalhos||[]).forEach(t=>{let l=t;l.programa=this.extra?.programas?.find(p=>p.id==l.programa_id)}),e?.forEach(t=>{let l=t;l.plano_trabalho=this.extra?.planos_trabalhos?.find(p=>p.id==l.plano_trabalho_id),l.avaliacao&&(l.avaliacao.tipo_avaliacao=this.extra?.tipos_avaliacoes?.find(p=>p.id==l.avaliacao.tipo_avaliacao_id))})}refreshConsolidacao(e){b(this,null,function*(){yield this.grid.query.refreshId(e.id,this.extraJoin),this.grid.refreshRows()})}dynamicButtons(e){let a=[],t=e,l=t.plano_trabalho.programa,p=!1,g=t.plano_trabalho.usuario_id,D=t.plano_trabalho.unidade_id,C=t.plano_trabalho.unidade,q=g==this.auth.usuario?.id,x=C?.gestor?.usuario_id==g,j=C?.gestores_substitutos.map(J=>J.usuario_id).includes(g),ie=C?.gestores_delegados.map(J=>J.usuario_id).includes(g),de=!x&&!j&&!ie,Ee=this.auth.hasPermissionTo("MOD_PTR_CSLD_AVAL"),ne=this.unidadeService.isGestorUnidadeSuperior(t.plano_trabalho?.unidade);x?p=ne:j?p=ne||this.unidadeService.isGestorTitularUnidade(D):ie?p=ne||this.unidadeService.isGestorUnidade(D,!1):de&&(p=ne||this.unidadeService.isGestorUnidade(D));let Ye={hint:"Avaliar",icon:"bi bi-star",color:"btn-outline-info",onClick:J=>this.planoTrabalhoService.avaliar(J,l,this.refreshConsolidacao.bind(this))},et={hint:"Reavaliar",icon:"bi bi-star-half",color:"btn-outline-warning",onClick:J=>this.planoTrabalhoService.avaliar(J,l,this.refreshConsolidacao.bind(this))},tt={label:"Recurso",id:"RECORRIDO",icon:"bi bi-journal-medical",color:"btn-outline-warning",onClick:J=>this.planoTrabalhoService.fazerRecurso(J,l,this.refreshConsolidacao.bind(this))},W={hint:"Cancelar avalia\xE7\xE3o",id:"INCLUIDO",icon:"bi bi-backspace",color:"btn-outline-danger",onClick:J=>this.planoTrabalhoService.cancelarAvaliacao(J,this,this.refreshConsolidacao.bind(this))};return t.status=="CONCLUIDO"&&!q&&p&&Ee&&a.push(Ye),t.status=="AVALIADO"&&t.avaliacao&&(q&&this.auth.hasPermissionTo("MOD_PTR_CSLD_REC_AVAL")&&t.avaliacao?.data_avaliacao&&a.push(tt),p&&(a.push(et),a.push(W))),a}onSelectTab(e){return b(this,null,function*(){this.viewInit&&this.saveUsuarioConfig({active_tab:e.key})})}initGrid(e){e.queryInit()}getAvaliacoes(e){return this.avaliacoes.filter(a=>a.plano_trabalho_consolidacao_id==e.id)}loadData(){return b(this,null,function*(){this.loading=!0;try{this.avaliacoes=yield this.avaliacaoDao.query({where:[["plano_trabalho_consolidacao_id","in",this.consolidacaoId]],join:this.joinAvaliacao,orderBy:[["data_avaliacao","desc"]]}).asPromise(),this.avaliacao=this.avaliacoes[0]||this.avaliacao}finally{this.loading=!1}})}onGridLoadHistorico(e){this.extra=(this.grid?.query||this.query).extra,(this.extra?.planos_trabalhos||[]).forEach(t=>{let l=t;l.programa=this.extra?.programas?.find(p=>p.id==l.programa_id)}),e?.forEach(t=>{this.consolidacaoId?.push(t.id);let l=t;l.plano_trabalho=this.extra?.planos_trabalhos?.find(p=>p.id==l.plano_trabalho_id),l.avaliacao&&(l.avaliacao.tipo_avaliacao=this.extra?.tipos_avaliacoes?.find(p=>p.id==l.avaliacao.tipo_avaliacao_id))}),this.loadData()}getNota(e){return e.tipo_avaliacao.notas.find(a=>a.codigo==e.nota)}};r.\u0275fac=function(a){return new(a||r)(V(R))},r.\u0275cmp=F({type:r,selectors:[["app-plano-trabalho-consolidacao-avaliacao"]],viewQuery:function(a,t){if(a&1&&y(k,5),a&2){let l;T(l=E())&&(t.grid=l.first)}},features:[U],decls:7,vars:5,consts:[["consolidacoes",""],["historico",""],["groupUnidadeUsuario",""],["usuario",""],["unidade",""],["subordinadas",""],["arquivadas",""],["columnConsolidacao",""],["columnExpandedConsolidacao",""],["columnPlanoTrabalho",""],["columnDataInicio",""],["columnDataFim",""],["columnEstatisticas",""],["columnStatus",""],["consolidacao",""],["groupHistorico",""],["columnHistorico",""],["columnExpandedHistorico",""],["gridEntregas",""],["columnAvaliador",""],["columnNota",""],["columnJustificativa",""],["columnRecurso",""],["right","",3,"title","select"],["key","CONSOLIDACOES","icon","bi bi-clipboard-check",3,"label","template"],["key","HISTORICO","icon","bi bi-clipboard-pulse","label","Hist\xF3rico de Avalia\xE7\xF5es",3,"template"],[3,"dao","orderBy","groupBy","join","init","hasAdd","hasEdit","loadList","groupTemplate"],[4,"ngIf"],[3,"form","where","submit","collapseChange","collapsed","deleted"],[1,"row"],["controlName","usuario_id",3,"size","control","dao"],["controlName","unidade_id",3,"change","size","control","dao"],["label","Sub.","controlName","unidades_subordinadas","labelInfo","Incluir as unidades subordinadas",3,"size","disabled","control"],["label","Arq.","controlName","incluir_arquivados","labelInfo","Incluir os planos de trabalhos arquivados",3,"size","control"],["type","expand",3,"icon","align","hint","template","expandTemplate"],[3,"title","template"],["title","Data in\xEDcio",3,"template"],["title","Data fim",3,"template"],[3,"title","template","width"],["title","Status",3,"template"],["type","options",3,"dynamicButtons"],[3,"rows"],[1,"d-flex"],[1,"ms-3"],[3,"url","size","hint"],[1,"flex-fill","ms-3"],["color","primary",3,"icon","label"],[3,"disabled","entity","planoTrabalho","cdRef"],["label","In\xEDcio","color","light","icon","bi bi-calendar2",3,"textValue"],["label","T\xE9rmino","color","light","icon","bi bi-calendar2-check",3,"textValue"],["color","light",3,"icon","label","hint"],[3,"align","tipoAvaliacao","nota",4,"ngIf"],["title","Recurso da avalia\xE7\xE3o","collapse","",3,"collapsed",4,"ngIf"],[3,"align","tipoAvaliacao","nota"],["title","Recurso da avalia\xE7\xE3o","collapse","",3,"collapsed"],[1,"one-per-line"],[3,"color","icon","label"],["icon","bi bi-journal-medical","color","warning","label","Recorrido",4,"ngIf"],["icon","bi bi-journal-medical","color","warning","label","Recorrido"],["type","expand",3,"icon","align","template","expandTemplate"],[3,"items","minHeight"],["title","Data","type","datetime","field","data_avaliacao"],["title","Avaliador",3,"template"],["title","Recurso",3,"template"],[1,"avaliador"],[1,"avaliador-profile"],[1,"avaliador-nome"],[3,"label","icon","color"],[3,"icon","label",4,"ngFor","ngForOf"],[3,"icon","label"],["icon","bi bi-check-circle","color","success","label","Vigente",4,"ngIf"],["icon","bi bi-check-circle","color","success","label","Vigente"]],template:function(a,t){if(a&1&&(c(0,"tabs",23)(1,"tab",24),_(2,Jo,37,42,"ng-template",null,0,f),d(),c(4,"tab",25),_(5,mn,30,36,"ng-template",null,1,f),d()()),a&2){let l=h(3),p=h(6);n("title",t.isModal?"":t.title)("select",t.onSelectTab.bind(t)),s(),n("label",t.lex.translate("Consolida\xE7\xF5es"))("template",l),s(3),n("template",p)}},dependencies:[re,z,k,K,Z,ge,Ve,Ue,ee,L,se,ve,Q,G,ze,He,Ze]});let o=r;return o})();var pn=[{path:"",component:Ge,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Planos de Trabalho"}},{path:"new",component:Xe,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Inclus\xE3o de Plano de Trabalho",modal:!0}},{path:"termo",component:aa,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Termo de ades\xE3o",modal:!0}},{path:"consolidacao/avaliacao",component:ua,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Avalia\xE7\xE3o das Consolida\xE7\xF5es do Plano de Trabalho"}},{path:"consolidacao/:consolidacaoId/avaliar",component:it,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Avaliar Consolida\xE7\xE3o do Plano de Trabalho"}},{path:"consolidacao/:consolidacaoId/recurso",component:it,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Recurso da Avalia\xE7\xE3o da Consolida\xE7\xE3o do Plano de Trabalho"}},{path:"consolidacao/:usuarioId/:planoTrabalhoId",component:Ke,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Consolida\xE7\xF5es do Plano de Trabalho"}},{path:"consolidacao",component:pa,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Consolida\xE7\xF5es"}},{path:":id/edit",component:Xe,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Edi\xE7\xE3o de Plano de Trabalho",modal:!0}},{path:":id/consult",component:Xe,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Consulta a Plano de Trabalho",modal:!0}},{path:"entrega-list",component:ye,canActivate:[B],resolve:{config:H},runGuardsAndResolvers:"always",data:{title:"Lista de Entregas do Plano de Trabalho",modal:!0}}],_a=(()=>{let r=class r{};r.\u0275fac=function(a){return new(a||r)},r.\u0275mod=Se({type:r}),r.\u0275inj=Ie({imports:[at.forChild(pn),at]});let o=r;return o})();var as=(()=>{let r=class r{};r.\u0275fac=function(a){return new(a||r)},r.\u0275mod=Se({type:r}),r.\u0275inj=Ie({imports:[ft,jt,gt,_a,Zt,ea]});let o=r;return o})();_t(Ge,[z,k,K,Z,ge,Ve,Ue,ee,L,fe,le,be,Rt,Bt,G,Me,ye],[]);export{as as PlanoTrabalhoModule};
